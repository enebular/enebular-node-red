/**
 * Copyright 2013, 2015 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED=function(){function i(){$.ajax({headers:{Accept:"text/html"},cache:!1,url:"nodes",success:function(e){$("body").append(e),$("body").i18n(),$("#palette > .palette-spinner").hide(),$(".palette-scroll").removeClass("hide"),$("#palette-search").removeClass("hide"),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){var t=window.location.hash;RED.nodes.version(e.rev),RED.nodes.import(e.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(t)&&RED.workspaces.show(t.substring(6)),RED.comms.subscribe("status/#",function(e,t){var n=e.split("/"),o=RED.nodes.node(n[1]);o&&(t.hasOwnProperty("text")&&(t.text=o._(t.text.toString(),{defaultValue:t.text.toString()})),o.status=t,a&&(o.dirty=!0,RED.view.redraw()))}),RED.comms.subscribe("node/#",function(e,t){var n,o,i;if("node/added"==e){var a=[];for(n=0;n<t.length;n++){var r=(o=t[n]).id;RED.nodes.addNodeSet(o),a=a.concat(o.types),RED.i18n.loadCatalog(r,function(){$.get("nodes/"+r,function(e){$("body").append(e)})})}a.length&&(i="<ul><li>"+a.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:a.length})+i,"success"))}else if("node/removed"==e)for(n=0;n<t.length;n++)o=t[n],RED.nodes.removeNodeSet(o.id).added&&(i="<ul><li>"+o.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:o.types.length})+i,"success"));else"node/enabled"==e?t.types&&(RED.nodes.getNodeSet(t.id).added?(RED.nodes.enableNodeSet(t.id),i="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:t.types.length})+i,"success")):$.get("nodes/"+t.id,function(e){$("body").append(e),i="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:t.types.length})+i,"success")})):"node/disabled"==e&&t.types&&(RED.nodes.disableNodeSet(t.id),i="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:t.types.length})+i,"success"));RED.library.loadFlowLibrary()})}})}})}function t(){$.get("red/about",function(e){RED.sidebar.info.set('<div style="text-align:center;"><img width="50px" src="red/images/node-red-icon.svg" /></div>'+marked(e)),RED.sidebar.info.show()})}var a=!1;function n(e){a=e,RED.view.status(a)}function e(){var e=[];e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-view-show-grid",label:RED._("menu.label.view.showGrid"),toggle:!0,onselect:RED.view.toggleShowGrid},{id:"menu-item-view-snap-grid",label:RED._("menu.label.view.snapGrid"),toggle:!0,onselect:RED.view.toggleSnapGrid},{id:"menu-item-status",label:RED._("menu.label.displayStatus"),toggle:!0,onselect:n,selected:!0},null,{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:RED.sidebar.toggleSidebar,selected:!0}]}),e.push(null),e.push({id:"menu-item-import",label:RED._("menu.label.import"),options:[{id:"menu-item-import-clipboard",label:RED._("menu.label.clipboard"),onselect:RED.clipboard.import},{id:"menu-item-import-library",label:RED._("menu.label.library"),options:[]}]}),e.push({id:"menu-item-export",label:RED._("menu.label.export"),disabled:!0,options:[{id:"menu-item-export-clipboard",label:RED._("menu.label.clipboard"),disabled:!0,onselect:RED.clipboard.export},{id:"menu-item-export-library",label:RED._("menu.label.library"),disabled:!0,onselect:RED.library.export}]}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:RED.search.show}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:function(){}}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:RED.workspaces.add},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:RED.workspaces.edit},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:RED.workspaces.remove}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:RED.subflow.createSubflow},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:RED.subflow.convertToSubflow}]}),e.push(null),!1!==RED.settings.theme("palette.editable")&&(RED.palette.editor.init(),e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:RED.palette.editor.show}),e.push(null)),e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:RED.keyboard.showHelp}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label","Node-RED website"),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:t}),RED.menu.init({id:"btn-sidemenu",options:e}),RED.user.init(),RED.library.init(),RED.palette.init(),RED.sidebar.init(),RED.subflow.init(),RED.workspaces.init(),RED.clipboard.init(),RED.search.init(),RED.view.init(),RED.editor.init(),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.keyboard.add("workspace",191,{shift:!0},function(){RED.keyboard.showHelp(),d3.event.preventDefault()}),RED.comms.connect(),$("#main-container").show(),$(".header-toolbar").show(),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e);for(var t=0,n=0;n<e.length;n++){var o=e[n];"node-red"!=o.module&&(t++,RED.i18n.loadCatalog(o.id,function(){0==--t&&i()}))}0===t&&i()}})}return $(function(){"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(document.title=document.title+" : "+window.location.hostname),ace.require("ace/ext/language_tools"),RED.i18n.init(function(){RED.settings.init(e)})}),{}}();RED.events=function(){var i={};return{on:function(e,t){i[e]=i[e]||[],i[e].push(t)},off:function(e,t){var n=i[e];if(n)for(var o=0;o<n.length;o++)if(n[o]===t)return void n.splice(o,1)},emit:function(t,e){if(i[t])for(var n=0;n<i[t].length;n++)try{i[t][n](e)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(e,t){i18n.loadNamespace(e,t)}},RED.settings=function(){var n={},o=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},i=function(o){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(e){!function(e){for(var t in n)n.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in e)e.hasOwnProperty(t)&&(RED.settings[t]=e[t]);n=e}(e),RED.settings.user&&RED.settings.user.anonymous&&RED.settings.remove("auth-tokens"),console.log("Node-RED: "+e.version),o()},error:function(e,t,n){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(o)})):console.log("Unexpected error:",e.status,t)}})};return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var n=t[1];RED.settings.set("auth-tokens",{access_token:n}),window.location.search=""}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),i(e)},load:i,set:function(e,t){o()&&localStorage.setItem(e,JSON.stringify(t))},get:function(e){if(o())return JSON.parse(localStorage.getItem(e))},remove:function(e){o()&&localStorage.removeItem(e)},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var i=0;i<n.length;i++)o=o[n[i]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function l(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),l()})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}return{init:function(){RED.settings.user&&(RED.settings.editorTheme&&RED.settings.editorTheme.hasOwnProperty("userMenu")||($('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"><i class="fa fa-user"></i></a></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-usermenu",options:[]}),l()))},login:function(a,r){"function"==typeof a&&(r=a,a={});var s=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');s.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!1,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(i){if("credentials"==i.type){var e=0;for(i.image?$("#node-dialog-login-image").attr("src",i.image):$("#node-dialog-login-image").attr("src","red/images/enebular-logo.png");e<i.prompts.length;e++){var t=i.prompts[e],n=$("<div/>",{id:"rrr"+e,class:"form-row"});$('<label for="node-dialog-login-'+t.id+'">'+t.label+":</label><br/>").appendTo(n);var o=$('<input style="width: 100%" id="node-dialog-login-'+t.id+'" type="'+t.type+'" tabIndex="'+(e+1)+'"/>').appendTo(n);e<i.prompts.length-1&&o.keypress(function(){var t=n;return function(e){13==e.keyCode&&(t.next("div").find("input").focus(),e.preventDefault())}}()),n.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(a.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(e){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var t={client_id:"node-red-editor",grant_type:"password",scope:""},n=0;n<i.prompts.length;n++){var o=i.prompts[n];t[o.id]=$("#node-dialog-login-"+o.id).val()}$.ajax({url:"auth/token",type:"POST",data:t}).done(function(e,t,n){RED.settings.set("auth-tokens",e),$("#node-dialog-login").dialog("destroy").remove(),a.updateMenu&&l(),r()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),e.preventDefault()}),a.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()})}s.dialog("open")}})},logout:function(){$.ajax({url:"auth/revoke",type:"POST",data:{token:RED.settings.get("auth-tokens").access_token},success:function(){RED.settings.remove("auth-tokens"),document.location.reload(!0)}})}}}(),RED.comms=function(){var o,i=null,s=null,l=null,d=10,c={},u=!1,p=0,f=!1;return{connect:function a(){f=!0;var e=location.hostname,t=location.port;0!==t.length&&(e=e+":"+t),e=(e+=document.location.pathname)+("/"==e.slice(-1)?"":"/")+"comms",e="ws"+("https:"==document.location.protocol?"s":"")+"://"+e;var n=RED.settings.get("auth-tokens");function r(){for(var e in c)c.hasOwnProperty(e)&&o.send(JSON.stringify({subscribe:e}))}u=null!=n,(o=new WebSocket(e)).onopen=function(){p=0,i&&(s=setTimeout(function(){i.close(),i=null},1e3)),u?o.send(JSON.stringify({auth:n.access_token})):r()},o.onmessage=function(e){var t=JSON.parse(e.data);if(u&&t.auth)"ok"===t.auth?(u=!1,r()):"fail"===t.auth&&(f=!1,RED.user.login({updateMenu:!0},function(){a()}));else if(t.topic)for(var n in c)if(c.hasOwnProperty(n)&&new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(t.topic)){var o=c[n];if(o)for(var i=0;i<o.length;i++)o[i](t.topic,t.data)}},o.onclose=function(){f&&(s&&(clearTimeout(s),s=null),++p<10?(setTimeout(a,1e3),5<p&&null==i&&(i=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):p<20?setTimeout(a,2e3):(d=60,l=setInterval(function(){if(0==--d)i.update(RED._("notification.errors.lostConnection")),clearInterval(l),a();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:d})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";i.update(e),$(i).find("a").click(function(e){e.preventDefault(),i.update(RED._("notification.errors.lostConnection")),clearInterval(l),a()})}},1e3)))}},subscribe:function(e,t){null==c[e]&&(c[e]=[]),c[e].push(t),o&&1==o.readyState&&o.send(JSON.stringify({subscribe:e}))},unsubscribe:function(e,t){if(c[e]){for(var n=0;n<c[e].length;n++)if(c[e][n]===t){c[e].splice(n,1);break}0===c[e].length&&delete c[e]}}}}(),RED.text={},RED.text.bidi=function(){var t="";function n(e){return"auto"==t?function(e){for(var t,n,o=e.length,i=0;i<o;i++){if(1488<=(n=e.charCodeAt(i))&&n<=1535||1536<=n&&n<=1631||1642<=n&&n<=1775||1786<=n&&n<=2047||64285<=n&&n<=65023||65136<=n&&n<=65276)return!0;if(64<(t=e.charCodeAt(i))&&t<91||96<t&&t<123)return!1}return!1}(e)?"rtl":"ltr":t}function o(){$(this).attr("dir",n($(this).val()))}return{setTextDirection:function(e){t=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",n($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",n($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var t=n(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:n,prepareInput:function(e){e.on("keyup",o).on("paste",o).on("cut",o),o.call(e)}}}(),RED.text.format=function(){var f=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},l=function(){function u(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function p(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var i=e.content,a=n.usePos&&n.startPos<i.length;a&&(n.start="",n.loops=!1),n.bStart=a?n.startPos:0<n.start.length?i.indexOf(n.start):0;var r=n.useLength&&0<n.length&&n.bStart+n.length<i.length;return r&&(n.end=""),n.bEnd=r?n.bStart+n.length:0<n.end.length?i.indexOf(n.end,n.bStart+n.start.length)+1:i.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(e,t,n,o,i){if(!n.content||"string"!=typeof n.content||0===n.content.length)return e;var a=!0;void 0!==n.loops&&(a=!!n.loops);for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e.keep||e[r].isSeparator)){var s=e[r].content,l=s.indexOf(n.content);if(!(l<0)){var d,c=0;if(n.continued)for(;c++,0===(d=s.indexOf(n.content,l+c*n.content.length)););else c=1;if(d=l+c*n.content.length,e.splice(r,1),0<l&&(e.splice(r,0,new f({content:s.substring(0,l),localGui:t.dir,keep:!0})),r++),e.splice(r,0,new f({content:s.substring(l,d),textDirection:n.subDir,localGui:t.dir})),d<s.length&&e.splice(r+1,0,new f({content:s.substring(d,s.length),localGui:t.dir,keep:!0})),!a)break}}},handleBounds:function(e,t,n,o,i){for(var a=0;a<n.length;a++)if(u(n[a]))for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e[r].inBounds||e.keep||e[r].isSeparator)){var s=p(e[r],n[a]),l=s.bStart,d=s.bEnd;if(!(l<0||d<0)){var c=e[r].content;if(e.splice(r,1),0<l&&(e.splice(r,0,new f({content:c.substring(0,l),localGui:t.dir,keep:!0})),r++),s.start&&(e.splice(r,0,new f({content:s.start,localGui:t.dir,isSeparator:!0})),r++),e.splice(r,0,new f({content:c.substring(l+s.start.length,d-s.end.length),textDirection:s.subDir,localGui:t.dir,inBounds:!0})),s.end&&(r++,e.splice(r,0,new f({content:s.end,localGui:t.dir,isSeparator:!0}))),d+s.end.length<c.length&&e.splice(r+1,0,new f({content:c.substring(d+s.end.length,c.length),localGui:t.dir,keep:!0})),!s.loops)break}}for(a=0;a<e.length;a++)e[a].inBounds=!1;return e},handleCases:function(e,t,n,o,i){if(0===n.length)return e;var a={};for(var r in t)t.hasOwnProperty(r)&&(a[r]=t[r]);for(var s=0;s<n.length;s++)n[s].handler&&"function"==typeof n[s].handler.handle||(n[s].handler=t.commonHandler),n[s].args?(a.cases=n[s].args.cases,a.points=n[s].args.points,a.bounds=n[s].args.bounds,a.subs=n[s].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),n[s].handler.handle(o,e,a,i);return e},handlePoints:function(e,t,n,o,i){for(var a=0;a<n.length;a++)for(var r=0;!(r>=e.length);r++)if(!(e[r].isParsed||e[r].keep||e[r].isSeparator)){var s=e[r].content,l=s.indexOf(n[a]);0<=l&&(e.splice(r,1),0<l&&(e.splice(r,0,new f({content:s.substring(0,l),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),r++),e.splice(r,0,new f({content:n[a],localGui:t.dir,isSeparator:!0})),l+n[a].length+1<=s.length&&e.splice(r+1,0,new f({content:s.substring(l+n[a].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}for(a=0;a<e.length;a++)e[a].keep?e[a].keep=!1:e[a].inPoints&&(e[a].isParsed=!0,e[a].inPoints=!1);return e}}}(),s={handle:function(e,t,n,o){var i=[];Array.isArray(n.cases)&&(i=n.cases);var a=[];void 0!==n.points&&(Array.isArray(n.points)?a=n.points:"string"==typeof n.points&&(a=n.points.split("")));var r={};"object"==typeof n.subs&&(r=n.subs);var s=[];return Array.isArray(n.bounds)&&(s=n.bounds),l.handleBounds(t,n,s,e,o),l.handleSubcontents(t,n,r,e,o),l.handleCases(t,n,i,e,o),l.handlePoints(t,n,a,e,o),t}},u={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),e=e.toLowerCase(),(o=(n=e)?n.split("-")[0]:"")&&!(o.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===o})){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}var n,o;return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var i=o?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(i);return a?a[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var i=""+e.charAt(o);switch(i){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=i}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+n+(""===a?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},d=function(){var e={};function r(e,t){var n=Array.isArray(e)?e[0]:e;return n.guiDir||(n.guiDir="ltr"),n.dir||(n.dir=n.guiDir),t&&(void 0===n.points&&(n.points=[]),n.cases||(n.cases=[]),n.bounds||(n.bounds=[]),n.commonHandler=s),n}function i(e,t,n){if(!e||!t)return new f({content:""});var o=r(t,!0),i=[new f({content:e,actual:e,localGui:o.dir})],a=s.handle;return o.handler&&"function"==typeof o.handler&&(a=o.handler.handle),a(e,i,o,n),i}function a(e,t,n){var o=r(t,!1);return n?function(e,t,n){for(var o="",i="",a=0;a<e.length;a++)if(e[a].isVisible){var r=e[a].textDirection,s=e[a].localGui;if(""!==s&&""===i?o+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>":""===i||""!==s&&s===i&&!stop||(o+="</bdi>"+(a==e.length-1&&""!==s?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==s&&(o+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>")),"auto"===r&&(r=u.getDirection(e[a].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(o+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>"+e[a].content+"</bdi>",r):(o+=e[a].content,u.getDirection(e[a].content,r,t.guiDir,!0)),a<e.length-1){var l=s&&e[a+1].localGui?s:t.dir;o+="<span style='unicode-bidi: embed; direction: "+("rtl"===l?"rtl":"ltr")+";'></span>"}else""!==i&&(o+="</bdi>");i=s,stop=!1}else stop=!0;var d="auto"===t.dir?u.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;d!==t.guiDir&&(o="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>"+o+"</bdi>");return o}(e,o):function(e,t,n){for(var o="",i="",a=!1,r=0;r<e.length;r++)if(e[r].isVisible){var s=e[r].textDirection,l=e[r].localGui;if(""!==l&&""===i?o+="rtl"===l?u.RLE:u.LRE:""===i||""!==l&&l===i&&!a||(o+=u.PDF+(r==e.length-1&&""!==l?"":"rtl"===t.dir?u.RLM:u.LRM),""!==l&&(o+="rtl"===l?u.RLE:u.LRE)),"auto"===s&&(s=u.getDirection(e[r].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(o+=("rtl"===s?u.RLE:u.LRE)+e[r].content+u.PDF,s):(o+=e[r].content,u.getDirection(e[r].content,s,t.guiDir,!0)),r<e.length-1){var d=l&&e[r+1].localGui?l:t.dir;o+="rtl"===d?u.RLM:u.LRM}else""!==i&&(o+=u.PDF);i=l,a=!1}else a=!0;var c="auto"===t.dir?u.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(o=("rtl"===c?u.RLE:u.LRE)+o+u.PDF);return o}(e,o)}return e.parseAndDisplayStructure=function(e,t,n,o){return e&&t?a(i(e,t,o),t,n):e},e.parseStructure=i,e.displayStructure=a,e.restore=function(e,t){return e},e}(),t={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},n={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},o={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:function(e,t){if("ar"!==u.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return 0<n&&n<e.length-1&&u.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}(e,i),points:"<>.:,;@",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},i={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},a={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},r={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:s,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:s,args:{subs:{content:" ",continued:!0}}},{handler:s,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},c={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},p={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},h={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},g={format:function(e,t,n,o,i,a){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},v={format:function(e,t,n,o,i,a){var r={},s="",l=Array.isArray(t)?t[0]:t;for(s in l)l.hasOwnProperty(s)&&(r[s]=l[s]);return r.guiDir=n?"rtl":"ltr",r.dir=r.dir?r.dir:r.guiDir,a?d.parseStructure(e,r,!!o,i):d.parseAndDisplayStructure(e,r,!!o,i)}},m=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function n(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=n(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:n(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function b(e){switch(e){case"breadcrumb":return t;case"comma":return n;case"email":return o;case"filepath":return i;case"formula":return a;case"sql":return r;case"underscore":return c;case"url":return p;case"word":return h;case"xpath":return g;default:return v}}function y(t,e,n,o,i){if(!t||1!=t.nodeType)return!1;m||(m=document.createEvent("Event")).initEvent("TF",!0,!0),t.setAttribute("data-tf-type",e);var a="undefined"===n?"{}":JSON.stringify(Array.isArray(n)?n[0]:n);t.setAttribute("data-tf-args",a);var r="ltr";if("undefined"===o&&(t.dir?r=t.dir:t.style&&t.style.direction&&(r=t.style.direction),o="rtl"===r.toLowerCase()),t.setAttribute("data-tf-dir",o),t.setAttribute("data-tf-locale",u.getLocaleDetails(i).lang),function(e){var t=window.navigator.userAgent;if(0<=t.indexOf("MSIE")||0<=t.indexOf("Trident")||0<=t.indexOf("Edge"))return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}(t)){t.oninput;t.oninput=function(e){D(e.target)}}else t.onkeyup=function(e){D(e.target),t.dispatchEvent(m)},t.onmouseup=function(e){D(e.target),t.dispatchEvent(m)};return D(t),!0}function D(e){var t=e.textContent||"",n=document.getSelection();if(0===t.length||!n||n.rangeCount<=0)e.dispatchEvent(m);else{var o,i,a=n.getRangeAt(0),r=a.cloneRange();o=a.startContainer,i=a.startOffset;var s=0;3===o.nodeType&&(s+=i),r.setStart(e,0),r.setEndBefore(o);var l=document.createElement("div");l.appendChild(r.cloneContents()),s+=l.textContent.length,e.innerHTML=b(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var d=e,c=e,u=0,p=!1;for(n.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(u+c.nodeValue.length>=s){a.setStart(c,s-u);break}u+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(d=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(d===e){p=!0;break}c=d.nextSibling,d=d.parentNode}if(p)break}n.addRange(a),e.dispatchEvent(m)}}return{getHtml:function(e,t,n,o,i){return b(t).format(e,n,o,!0,i)},attach:function(e,t,n,o,i){return y(e,t,n,o,i)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8},RED.nodes=function(){var V,u=[],J={},p=[],U={},r=[],a={},t=null,f={deleted:{},added:{}},o=!1;var s,l,d,c,h,g,H=(s={},l=[],d={},c={},h={},g={getModule:function(e){return s[e]},getNodeSetForType:function(e){return g.getNodeSet(c[e])},getModuleList:function(){return s},getNodeList:function(){return l},setNodeList:function(e){l=[];for(var t=0;t<e.length;t++){var n=e[t];g.addNodeSet(n)}},addNodeSet:function(e){e.added=!1,d[e.id]=e;for(var t=0;t<e.types.length;t++)c[e.types[t]]=e.id;l.push(e),s[e.module]=s[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},s[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var t=d[e],n=0;n<t.types.length;n++)delete c[t.types[n]];delete d[e];for(var o=0;o<l.length;o++)if(l[o].id===e){l.splice(o,1);break}return delete s[t.module].sets[t.name],0===Object.keys(s[t.module].sets).length&&delete s[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return d[e]},enableNodeSet:function(e){var t=d[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=d[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var n;"subflows"!=(h[e]=t).category&&(t.set=d[c[e]],d[c[e]].added=!0,d[c[e]].enabled=!0,n="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0);return-1===e[0].indexOf(":")&&(e[0]=n+":"+e[0]),RED._.apply(null,e)});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete h[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return h[e]}});function K(){return(1+4294967295*Math.random()).toString(16)}function X(e){if(0!==e.type.indexOf("subflow")&&(e._=e._def._),"config"==e._def.category)J[e.id]=e;else{if(e.ports=[],e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,E(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}u.push(e)}delete f.deleted[e.id],f.added[e.id]=!0,RED.events.emit("nodes:add",e)}function Y(e){p.push(e)}function v(e){if(e in J)return J[e];for(var t in u)if(u[t].id==e)return u[t];return null}function m(e){var t,o=[],i=[];if(e in J)t=J[e],delete J[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=v(e)){u.splice(u.indexOf(t),1),(o=p.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){p.splice(p.indexOf(e),1)});var a=!1;for(var r in t._def.defaults)if(t._def.defaults.hasOwnProperty(r)){var s=t._def.defaults[r];if(s.type){var l=H.getNodeType(s.type);if(l&&"config"==l.category){var d=J[t[r]];if(d)if(a=!0,d._def.exclusive)m(t[r]),i.push(d);else{var c=d.users;c.splice(c.indexOf(t),1)}}}}a&&RED.workspaces.refresh(),RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&t._def.onremove.call(n),delete f.added[e],f.deleted[e]=!0,i.forEach(function(e){delete f.added[e.id],f.deleted[e.id]=!0}),{links:o,nodes:i}}function q(e){U[e.id]=e,f.added[e.id]=!0,delete f.deleted[e.id],e._def={defaults:{label:{value:""}}},r.push(e.id)}function Z(t,e){if(e){var n=Object.keys(a).map(function(e){return a[e].name});n.sort();var o=1,i=t.name;n.forEach(function(e){i==e&&(o++,i=t.name+" ("+o+")")}),t.name=i}t._def={defaults:{},icon:"subflow.png",category:"subflows",color:"#da9",inputs:t.in.length,outputs:t.out.length},a[t.id]=t,delete f.deleted[t.id],f.added[t.id]=!0,RED.nodes.registerType("subflow:"+t.id,{defaults:{name:{value:""}},info:t.info,icon:"subflow.png",category:"subflows",inputs:t.in.length,outputs:t.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(t.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(t.id).name},set:{module:"node-red"}})}function Q(e){return a[e]}function ee(e,t){for(var n=0;n<u.length;n++){var o=u[n];if(o.z===e){var i=/^subflow:(.+)$/.exec(o.type);if(i){if(i[1]===t)return!0;if(ee(i[1],t))return!0}}}return!1}function b(e){var t={};for(var n in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function y(t,e){if("tab"===t.type)return b(t);e=e||!1;var n={};if(n.id=t.id,n.type=t.type,n.z=t.z,"unknown"==n.type)for(var o in t._orig)t._orig.hasOwnProperty(o)&&(n[o]=t._orig[o]);else{for(var i in t._def.defaults)t._def.defaults.hasOwnProperty(i)&&(n[i]=t[i]);if(e&&t.credentials){var a={};for(var r in n.credentials={},t._def.credentials)t._def.credentials.hasOwnProperty(r)&&("password"==t._def.credentials[r].type?(!t.credentials._||t.credentials["has_"+r]!=t.credentials._["has_"+r]||t.credentials["has_"+r]&&t.credentials[r])&&(a[r]=t.credentials[r]):null==t.credentials[r]||t.credentials._&&t.credentials[r]==t.credentials._[r]||(a[r]=t.credentials[r]));0<Object.keys(a).length&&(n.credentials=a)}}if("config"!=t._def.category){n.x=t.x,n.y=t.y,n.wires=[];for(var s=0;s<t.outputs;s++)n.wires.push([]);for(var l=p.filter(function(e){return e.source===t}),d=0;d<l.length;d++){var c=l[d];"subflow"!=c.target.type&&n.wires[c.sourcePort].push(c.target.id)}}return n}function D(a){var r={};return r.id=a.id,r.type=a.type,r.name=a.name,r.info=a.info,r.in=[],r.out=[],a.in.forEach(function(t){for(var e={x:t.x,y:t.y,wires:[]},n=p.filter(function(e){return e.source===t}),o=0;o<n.length;o++){var i=n[o];"subflow"!=i.target.type&&e.wires.push({id:i.target.id})}r.in.push(e)}),a.out.forEach(function(t,e){var n={x:t.x,y:t.y,wires:[]},o=p.filter(function(e){return e.target===t});for(i=0;i<o.length;i++)"subflow"!=o[i].source.type?n.wires.push({id:o[i].source.id,port:o[i].sourcePort}):n.wires.push({id:a.id,port:0});r.out.push(n)}),r}function w(e){for(var t=[],n={},o={},i=0;i<e.length;i++){var a=e[i];if("subflow:"==a.type.substring(0,8)){var r=a.type.substring(8);if(!o[r]){o[r]=!0;var s=[Q(r)];RED.nodes.eachNode(function(e){e.z==r&&s.push(e)}),t=w(s).concat(t)}}if("subflow"!=a.type){var l=RED.nodes.convertNode(a);for(var d in a._def.defaults)if(a._def.defaults[d].type&&a[d]in J){var c=J[a[d]],u=H.getNodeType(a._def.defaults[d].type).exportable;null==u||u?a[d]in n||(n[a[d]]=!0,e.push(c)):l[d]=""}t.push(l)}else{var p=D(a);t.push(p)}}return t}function te(r,s){var l,d=null;try{RED.nodes.eachSubflow(function(e){if(e.name==r.name&&e.info==r.info&&e.in.length==r.in.length&&e.out.length==r.out.length){var t=RED.nodes.filterNodes({z:e.id});if(t.length==s.length){var n=[r].concat(s),o=[e].concat(t),i=JSON.stringify(n),a=JSON.stringify(w(o));for(l=0;l<t.length;l++)i=i.replace(new RegExp('"'+s[l].id+'"',"g"),'"'+t[l].id+'"');if((i=i.replace(new RegExp('"'+r.id+'"',"g"),'"'+e.id+'"'))===a)throw d=e,new Error}}})}catch(e){console.log(e.stack)}return d}function ne(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var i in o.defaults)if(o.defaults.hasOwnProperty(i)){var a=e[i],r=t[i];if(typeof a!=typeof r)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==r)return!1}else if(JSON.stringify(a)!==JSON.stringify(r))return!1}return!0}function E(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=H.getNodeType(n.type);if(o&&"config"==o.category){var i=J[e[t]];i&&-1===i.users.indexOf(e)&&i.users.push(e)}}}}return{registry:H,setNodeList:H.setNodeList,getNodeSet:H.getNodeSet,addNodeSet:H.addNodeSet,removeNodeSet:H.removeNodeSet,enableNodeSet:H.enableNodeSet,disableNodeSet:H.disableNodeSet,registerType:H.registerNodeType,getType:H.getNodeType,convertNode:y,add:X,remove:m,addLink:Y,removeLink:function(e){var t=p.indexOf(e);-1!=t&&p.splice(t,1)},addWorkspace:q,removeWorkspace:function(e){delete U[e],r.splice(r.indexOf(e),1);var t,n,o=[],i=[];for(t=0;t<u.length;t++)(n=u[t]).z==e&&o.push(n);for(t in J)J.hasOwnProperty(t)&&(n=J[t]).z==e&&o.push(n);for(t=0;t<o.length;t++){var a=m(o[t].id);i=i.concat(a.links)}return f.deleted[e]=!0,delete f.added[e],{nodes:o,links:i}},getWorkspaceOrder:function(){return r},setWorkspaceOrder:function(e){r=e},workspace:function(e){return U[e]},addSubflow:Z,removeSubflow:function(e){delete a[e.id],delete f.added[e.id],f.deleted[e.id]=!0,H.removeNodeType("subflow:"+e.id)},subflow:Q,subflowContains:ee,eachNode:function(e){for(var t=0;t<u.length;t++)e(u[t])},eachLink:function(e){for(var t=0;t<p.length;t++)e(p[t])},eachConfig:function(e){for(var t in J)J.hasOwnProperty(t)&&e(J[t])},eachSubflow:function(e){for(var t in a)a.hasOwnProperty(t)&&e(a[t])},eachWorkspace:function(e){for(var t=0;t<r.length;t++)e(U[r[t]])},node:v,version:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){for(var t=[],n=0;n<u.length;n++){var o=u[n];e.hasOwnProperty("z")&&o.z!==e.z||e.hasOwnProperty("type")&&o.type!==e.type||t.push(o)}return t},filterLinks:function(e){for(var t=[],n=0;n<p.length;n++){var o=p[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:function(e,t,n){var o,i,a,r={};if("string"==typeof e){if(""===e)return;try{a=JSON.parse(e)}catch(f){var s=new Error(RED._("clipboard.invalidFlow",{message:f.message}));throw s.code="NODE_RED",s}}else a=e;$.isArray(a)||(a=[a]);var l=[];for(o=0;o<a.length;o++)"workspace"==(i=a[o]).type||"tab"==i.type||"subflow"==i.type||H.getNodeType(i.type)||"subflow:"==i.type.substring(0,8)||-1!=l.indexOf(i.type)||l.push(i.type),i.z&&(r[i.z]=r[i.z]||[],r[i.z].push(i));if(0<l.length){var d="<ul><li>"+l.join("</li><li>")+"</li></ul>",c=-1<("type"+(1<l.length?"s":"")).indexOf("s")?"nodes":"a node";RED.notify("<strong>"+RED._("clipboard.importUnrecognised",{count:l.length})+"</strong>"+d+"<p>It looks like you are using "+c+" not supported by enebular. Don&#39;t worry! It can take some time to install "+c+".</p><p>Please refresh your browser. If refreshing does not work, the node may be incompatible with the existing runtime.</p>","error",!1,15e3)}var u=RED.workspaces.active(),p=Q(u);if(p)for(o=0;o<a.length;o++){var f,h=/^subflow:(.+)$/.exec(a[o].type);if(h&&(h[1]===p.id&&(f=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),ee(h[1],p.id)&&(f=new Error(RED._("notification.errors.cannotAddCircularReference"))),f))throw f.code="NODE_RED",f}var g,v,m,b,y=[],D={},w=[],E={},R={},k={},_=[],x=[],T=null;for(o=0;o<a.length;o++)if("workspace"===(i=a[o]).type||"tab"===i.type)"workspace"===i.type&&(i.type="tab"),null==V&&(V=i),t&&(g=K(),D[i.id]=g,i.id=g),q(i),RED.workspaces.add(i),y.push(i);else if("subflow"===i.type){var C=te(i,r[i.id]);C?R[i.id]=C:(E[i.id]=i,t&&(g=K(),i.id=g),i.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=i.id,e.i=t,e.id=K()}),i.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=i.id,e.i=t,e.id=K()}),w.push(i),Z(i,t))}for(null==V&&(q(V={type:"tab",id:K(),label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(V),y.push(V),u=RED.workspaces.active()),o=0;o<a.length;o++)if(i=a[o],(v=H.getNodeType(i.type))&&"config"==v.category){var O=null;if(t){if(i.z){if(R[i.z])continue;E[i.z]?i.z=E[i.z].id:(i.z=D[i.z],U[i.z]||(n?(null===T&&(T=RED.workspaces.add(null,!0),y.push(T)),i.z=T.id):i.z=u))}if((O=RED.nodes.node(i.id))&&i.z&&O.z!==i.z)for(var S in O=null,J)if(J.hasOwnProperty(S)&&J[S].z===i.z&&ne(J[S],i,!1)){O=J[S],k[i.id]=J[S];break}}if(!O){for(b in m={id:i.id,z:i.z,type:i.type,users:[],_config:{}},v.defaults)v.defaults.hasOwnProperty(b)&&(m[b]=i[b],m._config[b]=JSON.stringify(i[b]));if(v.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials"))for(b in m.credentials={},v.credentials)v.credentials.hasOwnProperty(b)&&i.credentials.hasOwnProperty(b)&&(m.credentials[b]=i.credentials[b]);m.label=v.label,m._def=v,t&&(m.id=K()),k[i.id]=m,_.push(m),RED.nodes.add(m)}}for(o=0;o<a.length;o++)if("workspace"!==(i=a[o]).type&&"tab"!==i.type&&"subflow"!==i.type&&(!(v=H.getNodeType(i.type))||"config"!=v.category)){var N={x:i.x,y:i.y,z:i.z,type:0,wires:i.wires,changed:!1,_config:{}};if(t){if(R[i.z])continue;E[N.z]?N.z=E[N.z].id:(N.z=D[N.z],U[N.z]||(n?(null===T&&(T=RED.workspaces.add(null,!0),y.push(T)),N.z=T.id):N.z=u)),N.id=K()}else N.id=i.id,null!=N.z&&(U[N.z]||E[N.z])||(n?(null===T&&(T=RED.workspaces.add(null,!0),y.push(T)),N.z=T.id):N.z=u);if(N.type=i.type,N._def=v,"subflow"===i.type.substring(0,7)){var L=i.type.split(":")[1],P=R[L]||E[L]||Q(L);t&&(L=P.id,N.type="subflow:"+L,N._def=H.getNodeType(N.type),delete N.i),N.name=i.name,N.outputs=P.out.length,N.inputs=P.in.length}else{if(!N._def){N.x&&N.y?N._def={color:"#fee",defaults:{},label:"unknown: "+i.type,labelStyle:"node_label_italic",outputs:i.outputs||i.wires.length,set:H.getNodeSet("node-red/unknown")}:(N._def={category:"config",set:H.getNodeSet("node-red/unknown")},N.users=[]);var z={};for(var A in i)i.hasOwnProperty(A)&&"x"!=A&&"y"!=A&&"z"!=A&&"id"!=A&&"wires"!=A&&(z[A]=i[A]);N._orig=z,N.name=i.type,N.type="unknown"}if("config"!=N._def.category){for(b in N.inputs=i.inputs||N._def.inputs,N.outputs=i.outputs||N._def.outputs,N._def.defaults)N._def.defaults.hasOwnProperty(b)&&(N[b]=i[b],N._config[b]=JSON.stringify(i[b]));if(N._config.x=N.x,N._config.y=N.y,N._def.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials"))for(b in N.credentials={},N._def.credentials)N._def.credentials.hasOwnProperty(b)&&i.credentials.hasOwnProperty(b)&&(N.credentials[b]=i.credentials[b])}}X(N),RED.editor.validateNode(N),"config"!=(k[i.id]=N)._def.category&&_.push(N)}var I={catch:"scope",status:"scope","link in":"links","link out":"links"};for(o=0;o<_.length;o++){if((i=_[o]).wires){for(var M=0;M<i.wires.length;M++)for(var B=i.wires[M]instanceof Array?i.wires[M]:[i.wires[M]],G=0;G<B.length;G++)if(B[G]in k){var W={source:i,sourcePort:M,target:k[B[G]]};Y(W),x.push(W)}delete i.wires}for(var j in i._def.defaults)if(i._def.defaults.hasOwnProperty(j))if(i._def.defaults[j].type&&k[i[j]])i[j]=k[i[j]].id,(m=RED.nodes.node(i[j]))&&-1===m.users.indexOf(i)&&m.users.push(i);else if(I.hasOwnProperty(i.type)&&I[i.type]===j&&void 0!==i[j]&&null!==i[j])for(var F=0;F<i[j].length;F++)k[i[j][F]]&&(i[j][F]=k[i[j][F]].id);p&&/^link /.test(i.type)&&i.links&&(i.links=i.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===u})),RED.editor.validateNode(i)}for(o=0;o<w.length;o++)(i=w[o]).in.forEach(function(n){n.wires.forEach(function(e){var t={source:n,sourcePort:0,target:k[e.id]};Y(t),x.push(t)}),delete n.wires}),i.out.forEach(function(n){n.wires.forEach(function(e){var t;Y(t=E[e.id]&&E[e.id].id==i.id?{source:i.in[e.port],sourcePort:e.port,target:n}:{source:k[e.id]||E[e.id],sourcePort:e.port,target:n}),x.push(t)}),delete n.wires});return RED.workspaces.refresh(),[_,x,y,w,T]},pending:function(){return f},getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var i=o.shift(),a=p.filter(function(e){return e.source===i||e.target===i}),r=0;r<a.length;r++){var s=a[r].source===i?a[r].target:a[r].source,l=s.id;l||(l=s.direction+":"+s.i),t[l]||(t[l]=!0,n.push(s),o.push(s))}return n},createExportableNodeSet:w,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<r.length;t++)"tab"==U[r[t]].type&&n.push(b(U[r[t]]));for(t in a)a.hasOwnProperty(t)&&n.push(D(a[t]));for(t in J)J.hasOwnProperty(t)&&n.push(y(J[t],e));for(t=0;t<u.length;t++){var o=u[t];n.push(y(o,e))}return n},updateConfigNodeUsers:E,id:K,dirty:function(e){if(null==e)return o;(o=e)||(f={deleted:{},added:{}}),RED.events.emit("nodes:change",{dirty:o})}}}(),RED.history=function(){var u=[];return{markAllDirty:function(){for(var e=0;e<u.length;e++)u[e].dirty=!0},list:function(){return u},depth:function(){return u.length},push:function(e){u.push(e)},pop:function(){var e,t,n,o=u.pop(),i={};if(o){if("add"==o.t){if(o.nodes)for(e=0;e<o.nodes.length;e++)(t=RED.nodes.node(o.nodes[e])).z&&(i[t.z]=!0),RED.nodes.remove(o.nodes[e]);if(o.links)for(e=0;e<o.links.length;e++)RED.nodes.removeLink(o.links[e]);if(o.workspaces)for(e=0;e<o.workspaces.length;e++)RED.nodes.removeWorkspace(o.workspaces[e].id),RED.workspaces.remove(o.workspaces[e]);if(o.subflows)for(e=0;e<o.subflows.length;e++)RED.nodes.removeSubflow(o.subflows[e]),RED.workspaces.remove(o.subflows[e]);if(o.subflow&&(o.subflow.instances&&o.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),o.subflow.hasOwnProperty("changed")&&(n=RED.nodes.subflow(o.subflow.id))&&(n.changed=o.subflow.changed)),o.removedLinks)for(e=0;e<o.removedLinks.length;e++)RED.nodes.addLink(o.removedLinks[e])}else if("delete"==o.t){if(o.workspaces)for(e=0;e<o.workspaces.length;e++)RED.nodes.addWorkspace(o.workspaces[e]),RED.workspaces.add(o.workspaces[e]);if(o.subflow&&o.subflow.subflow&&RED.nodes.addSubflow(o.subflow.subflow),o.subflowInputs&&0<o.subflowInputs.length&&((n=RED.nodes.subflow(o.subflowInputs[0].z)).in.push(o.subflowInputs[0]),n.in[0].dirty=!0),o.subflowOutputs&&0<o.subflowOutputs.length)for(n=RED.nodes.subflow(o.subflowOutputs[0].z),o.subflowOutputs.sort(function(e,t){return e.i-t.i}),e=0;e<o.subflowOutputs.length;e++){var a=o.subflowOutputs[e];n.out.splice(a.i,0,a);for(var r=a.i+1;r<n.out.length;r++)n.out[r].i++,n.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+n.id&&e.sourcePort>=a.i&&e.sourcePort++})}if(o.subflow&&o.subflow.hasOwnProperty("instances")&&o.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),n&&RED.nodes.filterNodes({type:"subflow:"+n.id}).forEach(function(e){for(e.inputs=n.in.length,e.outputs=n.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),o.nodes)for(e=0;e<o.nodes.length;e++)RED.nodes.add(o.nodes[e]),i[o.nodes[e].z]=!0;if(o.links)for(e=0;e<o.links.length;e++)RED.nodes.addLink(o.links[e]);if(o.changes)for(e in o.changes)if(o.changes.hasOwnProperty(e)&&(t=RED.nodes.node(e))){for(var s in o.changes[e])o.changes[e].hasOwnProperty(s)&&(t[s]=o.changes[e][s]);t.dirty=!0}}else if("move"==o.t){for(e=0;e<o.nodes.length;e++){var l=o.nodes[e];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.changed=l.changed}if(o.links)for(e=0;e<o.links.length;e++)RED.nodes.removeLink(o.links[e]);if(o.removedLinks)for(e=0;e<o.removedLinks.length;e++)RED.nodes.addLink(o.removedLinks[e])}else if("edit"==o.t){for(e in o.changes)if(o.changes.hasOwnProperty(e)){if(o.node._def.defaults[e].type){var d=RED.nodes.node(o.node[e]);d&&d.users.splice(d.users.indexOf(o.node),1);var c=RED.nodes.node(o.changes[e]);c&&c.users.push(o.node)}o.node[e]=o.changes[e]}if(o.subflow?(o.subflow.hasOwnProperty("inputCount")&&(o.node.in.length>o.subflow.inputCount?o.node.in.splice(o.subflow.inputCount):0<o.subflow.inputs.length&&(o.node.in=o.node.in.concat(o.subflow.inputs))),o.subflow.hasOwnProperty("outputCount")&&(o.node.out.length>o.subflow.outputCount?o.node.out.splice(o.subflow.outputCount):0<o.subflow.outputs.length&&(o.node.out=o.node.out.concat(o.subflow.outputs))),o.subflow.hasOwnProperty("instances")&&o.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.nodes.filterNodes({type:"subflow:"+o.node.id}).forEach(function(e){e.inputs=o.node.in.length,e.outputs=o.node.out.length,RED.editor.updateNodeProperties(e)})):(RED.editor.updateNodeProperties(o.node),RED.editor.validateNode(o.node)),o.links)for(e=0;e<o.links.length;e++)RED.nodes.addLink(o.links[e]);o.node.dirty=!0,o.node.changed=o.changed}else if("createSubflow"==o.t){if(o.nodes)for(RED.nodes.filterNodes({z:o.subflow.subflow.id}).forEach(function(e){e.z=o.activeWorkspace,e.dirty=!0}),e=0;e<o.nodes.length;e++)RED.nodes.remove(o.nodes[e]);if(o.links)for(e=0;e<o.links.length;e++)RED.nodes.removeLink(o.links[e]);if(RED.nodes.removeSubflow(o.subflow.subflow),RED.workspaces.remove(o.subflow.subflow),o.removedLinks)for(e=0;e<o.removedLinks.length;e++)RED.nodes.addLink(o.removedLinks[e])}else"reorder"==o.t&&o.order&&RED.workspaces.order(o.order);Object.keys(i).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(o.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}},peek:function(){return u[u.length-1]}}}(),RED.validators={number:function(){return function(e){return""!==e&&!isNaN(e)}},regex:function(t){return function(e){return t.test(e)}}},function(s){s.widget("nodered.editableList",{_create:function(){var e,n=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),!1!==this.options.addButton)&&(e="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",s('<a href="#" class="editor-button editor-button-small" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+e+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),n.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=n.element.css(e);"auto"!==e&&""!==e&&(n.topContainer.css(e,t),n.uiContainer.css(e,"0"),n.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var t=this.element.css("minHeight");"0px"!==t&&(this.uiContainer.css("minHeight",t),this.element.css("minHeight",0)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var o,i=this.element.attr("style");if(null!==(o=/width\s*:\s*(\d+%)/i.exec(i))&&(this.element.width("100%"),this.uiContainer.width(o[1])),this.options.sortable){var a={axis:"y",update:function(e,t){n.options.sortItems&&n.options.sortItems(n.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(a.connectWith=this.options.connectWith),this.element.sortable(a)}this._resize()},_resize:function(){var e=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-e),this.options.resize&&this.options.resize(),this.options.resizeItem){var t=this;this.element.children().each(function(e){t.options.resizeItem(s(this).find(".red-ui-editableList-item-content"),e)})}},_destroy:function(){},_refreshFilter:function(){var o=this,i=0;return this.activeFilter||this.element.children().show(),this.items().each(function(e,t){var n=t.data("data");try{o.activeFilter(n)?(t.parent().show(),i++):t.parent().hide()}catch(e){console.log(e),t.parent().show(),i++}}),i},_refreshSort:function(){if(this.activeSort){var e=this.element.children(),n=this;e.sort(function(e,t){return n.activeSort(s(e).find(".red-ui-editableList-item-content").data("data"),s(t).find(".red-ui-editableList-item-content").data("data"))}),s.each(e,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(o){var i=this;o=o||{};var a=s("<li>"),r=!1;if(this.activeSort){this.items().each(function(e,t){if(!r){var n=t.data("data");i.activeSort(o,n)<0&&(a.insertBefore(t.closest("li")),r=!0)}})}r||a.appendTo(this.element);var t=s("<div/>").addClass("red-ui-editableList-item-content").appendTo(a);if(t.data("data",o),!0===this.options.sortable&&(s('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(a),a.addClass("red-ui-editableList-item-sortable")),this.options.removable){var e=s("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(a);s("<i/>",{class:"fa fa-remove"}).appendTo(e),a.addClass("red-ui-editableList-item-removable"),e.click(function(){var e=t.data("data");a.addClass("red-ui-editableList-item-deleting"),a.fadeOut(300,function(){s(this).remove(),i.options.removeItem&&i.options.removeItem(e)})})}if(this.options.addItem){var n=i.element.children().length-1;setTimeout(function(){if(i.options.addItem(t,n,o),i.activeFilter)try{i.activeFilter(o)||a.hide()}catch(e){}!i.activeSort&&i.scrollOnAdd&&setTimeout(function(){i.uiContainer.scrollTop(i.element.height())},0)},0)}},removeItem:function(t){this.element.children().filter(function(e){return t===s(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(e){return s(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),RED.menu=function(){var d={};function c(o){var e,t,n;if(null!==o&&o.id&&!1===RED.settings.theme("menu."+o.id))return null;if(null===o)e=$('<li class="divider"></li>');else{e=$("<li></li>"),o.group&&e.addClass("menu-group-"+o.group);var i="<a "+(o.id?'id="'+o.id+'" ':"")+'tabindex="-1" href="#">';o.toggle&&(i+='<i class="fa fa-square pull-left"></i>',i+='<i class="fa fa-check-square pull-left"></i>'),void 0!==o.icon&&(/\.png/.test(o.icon)?i+='<img src="'+o.icon+'"/> ':i+='<i class="'+(o.icon?o.icon:'" style="display: inline-block;"')+'"></i> '),o.sublabel?i+='<span class="menu-label-container"><span class="menu-label">'+o.label+'</span><span class="menu-sublabel">'+o.sublabel+"</span></span>":i+='<span class="menu-label">'+o.label+"</span>",i+="</a>";var a=$(i).appendTo(e);if((d[o.id]=o).onselect?(a.click(function(){if(!$(this).parent().hasClass("disabled"))if(o.toggle){var e=u(o.id);if("string"==typeof o.toggle){if(!e){for(var t in d)if(d.hasOwnProperty(t)){var n=d[t];n.id!=o.id&&o.toggle==n.toggle&&p(n.id,!1)}p(o.id,!0)}}else p(o.id,!e)}else o.onselect.call(o)}),t=o.id,(n=RED.settings.get("menu-"+t))?(a.addClass("active"),o.onselect.call(o,!0)):!1===n?(a.removeClass("active"),o.onselect.call(o,!1)):o.hasOwnProperty("selected")&&(o.selected?a.addClass("active"):a.removeClass("active"),o.onselect.call(o,o.selected))):o.href?a.attr("target","_blank").attr("href",o.href):o.options||(e.addClass("disabled"),a.click(function(e){e.preventDefault()})),o.options){e.addClass("dropdown-submenu pull-left");for(var r=$('<ul id="'+o.id+'-submenu" class="dropdown-menu"></ul>').appendTo(e),s=0;s<o.options.length;s++){var l=c(o.options[s]);l&&l.appendTo(r)}}o.disabled&&e.addClass("disabled")}return e}function u(e){return $("#"+e).hasClass("active")}function p(e,t){if(u(e)!=t){var n,o,i=d[e];t?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),i&&i.onselect&&i.onselect.call(i,t),n=e,o=t,RED.settings.set("menu-"+n,o)}}return{init:function(e){for(var t=$("#"+e.id),n=$("<ul/>",{id:e.id+"-submenu",class:"dropdown-menu pull-right"}).insertAfter(t),o=!1,i=0;i<e.options.length;i++){var a=e.options[i];if(null!==a||!o){var r=c(a);r&&(r.appendTo(n),o=null===a)}}},setSelected:p,isSelected:u,setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,t){var n=c(t);if(t.group){var o=$("#"+e+"-submenu").children(".menu-group-"+t.group);if(0===o.length)n.appendTo("#"+e+"-submenu");else{for(var i=0;i<o.length;i++){var a=o[i],r=$(a).find(".menu-label").html();if(t.label<r){$(a).before(n);break}}i===o.length&&n.appendTo("#"+e+"-submenu")}}else n.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){var n=d[e];n&&(n.onselect=t)}}}(),RED.popover={create:function(e){var i,a,r=e.target,s=e.content,t=e.delay,n=null,o=function(){if(i){a=$('<div class="red-ui-popover"></div>').html(s).appendTo("body");var e=r.offset(),t=r.width(),n=r.height(),o=a.height();a.css({top:e.top+n/2-o/2-10,left:e.left+t+17}),a.fadeIn("fast")}},l=function(){i||a&&(a.fadeOut("fast",function(){$(this).remove()}),a=null)};r.on("mouseenter",function(e){clearTimeout(n),i=!0,n=setTimeout(o,t.show)}),r.on("mouseleave",function(e){n&&clearTimeout(n),i=!1,setTimeout(l,t.hide)});var d={setContent:function(e){s=e}};return r.data("popover",d),d}},function(n){n.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),n('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=n('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=n("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(e){t._change(n(this).val())}),this.element.on("focus",function(){n("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&0<this.options.delay){clearTimeout(this.currentTimeout);var i=this;this.currentTimeout=setTimeout(function(){i.lastSent=i.element.val(),i._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()}})}(jQuery),RED.tabs={create:function(l){var a,o,i,d={},r=0,c=$("#"+l.id),s=c.wrap("<div>").parent(),u=c.wrap("<div>").parent();function t(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=u.scrollLeft();u.animate({scrollLeft:t},100);var o=setInterval(function(){var e=u.scrollLeft();e!==n?(n=e,u.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function p(){return g($(this)),!1}function f(){if(0!==c.children().length){var e=u.scrollLeft(),t=u.width(),n=c.width();0===e?o.hide():o.show(),e===n-t?i.hide():i.show()}}function h(){return l.ondblclick&&l.ondblclick(d[$(this).attr("href").slice(1)]),!1}function g(e){if("string"==typeof e&&(e=c.find("a[href='#"+e+"']")),!e.parent().hasClass("active")){if(c.children().removeClass("active"),c.children().css({transition:"width 100ms"}),e.parent().addClass("active"),l.scrollable){var t=e.parent().position().left;t-21<0?u.animate({scrollLeft:"+="+(t-50)},300):t+120>u.width()&&u.animate({scrollLeft:"+="+(t+140-u.width())},300)}l.onchange&&l.onchange(d[e.attr("href").slice(1)]),v(),setTimeout(function(){c.children().css({transition:""})},100)}}function v(){var e=c.find("li.red-ui-tab"),t=s.width(),n=e.size(),o=(t-12-6*n)/n;if(r=(a=100*o/t+"%")+"%",l.scrollable){o=Math.max(o,140),a=o+"px",r=0;var i=Math.max(s.width(),12+(o+6)*n);c.width(i),f()}else l.hasOwnProperty("minimumActiveTabWidth")&&(o<l.minimumActiveTabWidth?(n-=1,o=(t-12-l.minimumActiveTabWidth-6*n)/n,a=100*o/t+"%",r=l.minimumActiveTabWidth+"px"):r=0);e.css({width:a}),o<50?(c.find(".red-ui-tab-close").hide(),c.find(".red-ui-tab-icon").hide(),c.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,o-38))+"px"})):(c.find(".red-ui-tab-close").show(),c.find(".red-ui-tab-icon").show(),c.find(".red-ui-tab-label").css({paddingLeft:""})),0!==r&&(c.find("li.red-ui-tab.active").css({width:l.minimumActiveTabWidth}),c.find("li.red-ui-tab.active .red-ui-tab-close").show(),c.find("li.red-ui-tab.active .red-ui-tab-icon").show(),c.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}function m(e){var t=c.find("a[href='#"+e+"']").parent();if(t.hasClass("active")){var n=t.prev();0===n.size()&&(n=t.next()),g(n.find("a"))}t.remove(),l.onremove&&l.onremove(d[e]),delete d[e],v()}return s.addClass("red-ui-tabs"),l.addButton&&"function"==typeof l.addButton&&(s.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(s).find("a").click(function(e){e.preventDefault(),l.addButton()})),l.scrollable&&(s.addClass("red-ui-tabs-scrollable"),u.addClass("red-ui-tabs-scroll-container"),u.scroll(f),(o=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(s).find("a")).on("mousedown",function(e){t(e,"-=150")}).on("click",function(e){e.preventDefault()}),(i=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(s).find("a")).on("mousedown",function(e){t(e,"+=150")}).on("click",function(e){e.preventDefault()})),c.children().first().addClass("active"),c.children().addClass("red-ui-tab"),c.find("li.red-ui-tab a").on("click",p).on("dblclick",h),setTimeout(function(){v()},0),{addTab:function(t){d[t.id]=t;var n=$("<li/>",{class:"red-ui-tab"}).appendTo(c);n.data("tabId",t.id);var e=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(n);if(t.icon&&$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(e),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(e).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),e.on("click",p),e.on("dblclick",h),t.closeable){var o=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(n);o.append('<i class="fa fa-times" />'),o.on("click",function(e){m(t.id)})}if(v(),l.onadd&&l.onadd(t),e.attr("title",t.label),1==c.find("li.red-ui-tab").size()&&g(e),l.onreorder){var i,a,r,s=[];n.draggable({axis:"x",distance:20,start:function(e,t){i=[],s=[],c.children().each(function(e){s[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(n)&&(r=a=e),i.push($(this).data("tabId"))}),c.children().each(function(e){e!==a&&$(this).css({position:"absolute",left:s[e].left+"px",width:s[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=s[a].left+u.scrollLeft();for(var n=t.position.left+s[a].width/2-u.scrollLeft(),o=0;o<s.length;o++)if(o!==a&&n>s[o].left&&n<s[o].left+s[o].width){o<a?(s[o].left+=s[a].width+8,s[a].el.detach().insertBefore(s[o].el)):(s[o].left-=s[a].width+8,s[a].el.detach().insertAfter(s[o].el)),s[o].el.css({left:s[o].left+"px"}),s.splice(o,0,s.splice(a,1)[0]),a=o;break}},stop:function(e,t){c.children().css({position:"relative",left:"",transition:""}),n.hasClass("active")||n.css({zIndex:""}),v(),r!==a&&l.onreorder(i,$.makeArray(c.children().map(function(){return $(this).data("tabId")}))),g(s[a].el.data("tabId"))}})}},removeTab:m,activateTab:g,resize:v,count:function(){return c.find("li.red-ui-tab").size()},contains:function(e){return 0<c.find("a[href='#"+e+"']").length},renameTab:function(e,t){d[e].label=t;var n=c.find("a[href='#"+e+"']");n.attr("title",t),n.find("span").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),v()},order:function(e){var t=$.makeArray(c.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var i={};for(c.children().detach().each(function(){i[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)i[e[n]].appendTo(c)}}}}}},function(s){function e(e){for(var t,n,o=e.length,i=0,a=!1,r=!1,s=0;s<o;s++){var l=e[s];if(a){if(l===t){if(!/\]/.test(e[s+1]))return!1;i=s+1,a=!1}}else if("'"===l||'"'===l){if(!r)return!1;a=!0,t=l,i=s+1}else if("."===l){if(0===s||s===o-1)return!1;if(!/[a-z0-9\$\_]/i.test(e[s+1]))return!1;i=s+1}else if("["===l){if(0===s)return!1;if(s===o-1)return!1;if(!/["'\d]/.test(e[s+1]))return!1;i=s+1,r=!0}else if("]"===l){if(!r)return!1;if(i!=s&&(n=e.substring(i,s),!/^\d+$/.test(n)))return!1;i=s+1,r=!1}else if(" "===l)return!1}return!r&&!a}var a={msg:{value:"msg",label:"msg.",validate:e},flow:{value:"flow",label:"flow.",validate:e},global:{value:"global",label:"global.",validate:e},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1}},r=!1;s.widget("nodered.typedInput",{_create:function(){if(!r&&RED&&RED._)for(var e in a)a.hasOwnProperty(e)&&(a[e].label=RED._("typedInput.type."+e,{defaultValue:a[e].label}));r=!0;var n=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var t,o=this.element.attr("style");if(null!==(t=/width\s*:\s*(\d+%)/i.exec(o))?(this.element.css("width","100%"),this.uiSelect.width(t[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=n.element.css("margin"+e);n.uiSelect.css("margin"+e,t),n.element.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(a),this.selectTrigger=s('<a href="#"></a>').prependTo(this.uiSelect),s('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=s("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=s(this.options.typeField).hide();var i=this.typeField.val();i&&this.typeMap[i]&&(this.options.default=i)}else this.typeField=s("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){n.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){n.validate()}),this.selectTrigger.click(function(e){e.preventDefault(),1<n.typeList.length?n._showMenu(n.menu,n.selectTrigger):n.element.focus()}),this.optionSelectTrigger=s('<a href="#" class="red-ui-typedInput-option-trigger" style="display:inline-block"><i class="fa fa-sort-desc"></i></a>').appendTo(this.uiSelect),this.optionSelectLabel=s("<span></span>").prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(e){e.preventDefault(),n.optionMenu&&(n.optionMenu.css({minWidth:n.optionSelectLabel.width()}),n._showMenu(n.optionMenu,n.optionSelectLabel))}),this.type(this.options.default||this.typeList[0].value)},_hideMenu:function(e){s(document).off("mousedown.close-property-select"),e.hide(),this.element.focus()},_createMenu:function(e,n){var o=this,i=s("<div>").addClass("red-ui-typedInput-options");return e.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var e=s('<a href="#">').attr("value",t.value).appendTo(i);t.label&&e.text(t.label),t.icon?s("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(e):e.css({paddingLeft:"18px"}),e.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(i)})}),i.css({display:"none"}),i.appendTo(document.body),i},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,e=n.offset(),i=n.height(),a=t.height(),r=i+e.top-3;r+a>s(window).height()&&(r-=r+a-s(window).height()+5),t.css({top:r+"px",left:2+e.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),s(document).on("mousedown.close-property-select",function(e){s(e.target).closest(t).length||o._hideMenu(t),s(e.target).closest(n).length&&(o.disarmClick=!0,e.preventDefault())})})}},_getLabelWidth:function(e){var t=e.outerWidth();if(0===t){var n=s('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);t=e.clone().appendTo(n).outerWidth(),n.remove()}return t},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&!1===this.typeMap[this.propertyType].hasValue)this.selectTrigger.css("width","100%");else{this.selectTrigger.width("auto");var e=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",e+"px"),this.optionSelectTrigger&&this.optionSelectTrigger.css("left",e+5+"px")}},_destroy:function(){this.menu.remove()},types:function(e){var n=this,t=this.type();this.typeMap={},this.typeList=e.map(function(e){var t;return t="string"==typeof e?a[e]:e,n.typeMap[t.value]=t}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){n.type(e)}),t&&!this.typeMap.hasOwnProperty(t)&&this.type(this.typeList[0].value)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length)return this.element.val();this.typeMap[this.propertyType].options&&(-1===this.typeMap[this.propertyType].options.indexOf(e)&&(e=""),this.optionSelectLabel.text(e)),this.element.val(e),this.element.trigger("change",this.type(),e)},type:function(e){if(!arguments.length)return this.propertyType;var t=this,n=this.typeMap[e];if(n&&this.propertyType!==e){var o;if(this.propertyType=e,this.typeField.val(e),this.selectLabel.empty(),n.icon?((o=new Image).name=n.icon,o.src=n.icon,s("<img>",{src:n.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(n.label),n.options){if(this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(n.options,function(e){t.optionSelectLabel.text(e),t.value(e)});var i=this.element.val();-1!==n.options.indexOf(i)?this.optionSelectLabel.text(i):this.value(n.options[0])}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===n.hasValue?(this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.element.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),this.element.trigger("change",this.propertyType,this.value());o?(o.onload=function(){t._resize()},o.onerror=function(){t._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.deploy=function(){var t={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},g={unknown:!1,unusedConfig:!1,invalid:!1},v="full";function i(e){v=e,$("#btn-deploy-icon").attr("src",t[e].img)}function m(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o="";if("function"==typeof e._def.label)try{o=e._def.label.call(e)}catch(e){console.log("Definition error: "+node_def.type+".label",e),o=node_def.type}else o=e._def.label;return o=o||e.id,{tab:t,type:e.type,label:o}}function b(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function a(e,t){var n=document.querySelector("#enebular-screenshot");n&&n.remove();var o=document.querySelector("#chart").cloneNode(!0);o.setAttribute("id","enebular-screenshot"),o.setAttribute("style","display: none"),document.body.appendChild(o),d3.select("#enebular-screenshot").selectAll("image.node_icon, image.node_error, image.node_changed").remove(),d3.select("#enebular-screenshot > svg").attr("width","100%").attr("height","500px"),d3.select("#enebular-screenshot > svg > g > g > rect").attr("width","100%").attr("height","auto").attr("fill","#f7fafb"),d3.select("#enebular-screenshot > svg > g > g").attr("transform","scale(0.75)"),d3.select("#enebular-screenshot > svg > g > g > g").remove();var i=document.querySelector("#enebular-screenshot").innerHTML;if(!$("#btn-deploy").hasClass("disabled")){if(!e){var a,r=!1,s=!1,l=[],d=[];RED.nodes.eachNode(function(e){r=r||!e.valid,e.valid||d.push(m(e)),"unknown"===e.type&&-1==l.indexOf(e.name)&&l.push(e.name)}),a=0<l.length;var c=[];RED.nodes.eachConfig(function(e){0===e.users.length&&!1!==e._def.hasUsers&&(c.push(m(e)),s=!0)}),$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").hide();var u=!1;if(a&&!g.unknown?(u=!0,$("#node-dialog-confirm-deploy-type").val("unknown"),$("#node-dialog-confirm-deploy-unknown").show(),$("#node-dialog-confirm-deploy-unknown-list").html("<li>"+l.join("</li><li>")+"</li>")):r&&!g.invalid?(u=!0,$("#node-dialog-confirm-deploy-type").val("invalid"),$("#node-dialog-confirm-deploy-config").show(),d.sort(b),$("#node-dialog-confirm-deploy-invalid-list").html("<li>"+d.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"}).join("</li><li>")+"</li>")):s&&g.unusedConfig,u)return $("#node-dialog-confirm-deploy-hide").prop("checked",!1),void $("#node-dialog-confirm-deploy").dialog("open")}var p=RED.nodes.createCompleteNodeSet(),f=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var h={flows:p,screenshot:i};t||(h.rev=RED.nodes.version()),$.ajax({url:"flows",type:"POST",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":v}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),s?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify(RED._("deploy.successfulDeploy"),"success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,n){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?($("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").show(),$("#node-dialog-confirm-deploy-type").val("conflict"),$("#node-dialog-confirm-deploy").dialog("open")):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){var e=Math.max(0,300-(Date.now()-f));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide()},e)})}}return{init:function(e){var t=(e=e||{}).type||"default";if("default"==t)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&i("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&i("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&i("nodes")}}]});else if("simple"==t){var n=e.label||RED._("deploy.deploy"),o="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(o=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(o?'<img id="btn-deploy-icon" src="'+o+'"> ':"")+"<span>"+n+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(){a()}),$("#node-dialog-confirm-deploy").dialog({title:RED._("deploy.confirm.button.confirm"),modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("deploy.confirm.button.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){$("#node-dialog-confirm-deploy-hide").prop("checked")&&(g[$("#node-dialog-confirm-deploy-type").val()]=!0),a(!0,"conflict"===$("#node-dialog-confirm-deploy-type").val()),$(this).dialog("close")}}],create:function(){$("#node-dialog-confirm-deploy").parent().find("div.ui-dialog-buttonpane").prepend('<div style="height:0; vertical-align: middle; display:inline-block; margin-top: 13px; float:left;"><input style="vertical-align:top;" type="checkbox" id="node-dialog-confirm-deploy-hide"><label style="display:inline;" for="node-dialog-confirm-deploy-hide"> do not warn about this again</label><input type="hidden" id="node-dialog-confirm-deploy-type"></div>')},open:function(){"conflict"===$("#node-dialog-confirm-deploy-type").val()?$("#node-dialog-confirm-deploy-hide").parent().hide():$("#node-dialog-confirm-deploy-hide").parent().show()}}),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))})}}}(),RED.keyboard=function(){var d={};function t(e){var t=d;if((e.ctrlKey||e.metaKey)&&(t=t.ctrl),t&&e.shiftKey&&(t=t.shift),t&&e.altKey&&(t=t.alt),t&&t[e.keyCode]){var n=t[e.keyCode];if(n.scope&&"*"!==n.scope){for(var o=e.target;"BODY"!==o.nodeName&&o.id!==n.scope;)o=o.parentElement;"BODY"===o.nodeName&&(n=null)}return n}}d3.select(window).on("keydown",function(){var e=t(d3.event);e&&e.ondown&&e.ondown()}),d3.select(window).on("keyup",function(){var e=t(d3.event);e&&e.onup&&e.onup()});var e=null;return{add:function(e,t,n,o,i){var a=n,r=o,s=i;"function"==typeof n&&(a={},r=n,s=o);var l=d;a.ctrl&&(l.ctrl=l.ctrl||{},l=l.ctrl),a.shift&&(l.shift=l.shift||{},l=l.shift),a.alt&&(l.alt=l.alt||{},l=l.alt),l[t]={scope:e,ondown:r,onup:s}},remove:function(e,t){var n=t||{},o=d;n.ctrl&&(o=o.ctrl),o&&n.shift&&(o=o.shift),o&&n.alt&&(o=o.alt),o&&delete o[e]},showHelp:function(){RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&(e||(e=$('<div id="keyboard-help-dialog" class="hide"><div style="vertical-align: top;display:inline-block; box-sizing: border-box; width:50%; padding: 10px;"><table class="keyboard-shortcuts"><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">a</span></td><td>'+RED._("keyboard.selectAll")+'</td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key">Click</span></td><td>'+RED._("keyboard.selectAllConnected")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">Click</span></td><td>'+RED._("keyboard.addRemoveNode")+'</td></tr><tr><td>&nbsp;</td><td></td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">i</span></td><td>'+RED._("keyboard.importNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">e</span></td><td>'+RED._("keyboard.exportNode")+'</td></tr><tr><td>&nbsp;</td><td></td></tr><tr><td><span class="help-key"> &#x2190; </span> <span class="help-key"> &#x2191; </span> <span class="help-key"> &#x2192; </span> <span class="help-key"> &#x2193; </span></td><td>'+RED._("keyboard.nudgeNode")+'</td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key"> &#x2190; </span></td><td rowspan="4">'+RED._("keyboard.moveNode")+'</td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key"> &#x2191; </span></td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key"> &#x2192; </span></td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key"> &#x2193; </span></td></tr></table></div><div style="vertical-align: top;display:inline-block; box-sizing: border-box; width:50%; padding: 10px;"><table class="keyboard-shortcuts"><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">Space</span></td><td>'+RED._("keyboard.toggleSidebar")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">.</span></td><td>'+RED._("keyboard.searchBox")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">Shift</span> + <span class="help-key">p</span></td><td>'+RED._("keyboard.managePalette")+'</td></tr><tr><td></td><td></td></tr><tr><td><span class="help-key">Delete</span></td><td rowspan="2">'+RED._("keyboard.deleteSelected")+'</td></tr><tr><td><span class="help-key">Backspace</span></td></tr><tr><td></td><td></td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">c</span></td><td>'+RED._("keyboard.copyNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">x</span></td><td>'+RED._("keyboard.cutNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">v</span></td><td>'+RED._("keyboard.pasteNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">z</span></td><td>'+RED._("keyboard.undoChange")+"</td></tr></table></div></div>").appendTo("body").dialog({modal:!0,autoOpen:!1,width:"800",title:"Keyboard shortcuts",resizable:!1})),e.dialog("open"))}}}(),RED.workspaces=function(){var i,n=0,o=0;function a(e,t){if(e)i.addTab(e),i.resize();else{for(var n=RED.nodes.id();o+=1,0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:o})+"']").size(););e={type:"tab",id:n,label:RED._("workspace.defaultName",{number:o})},RED.nodes.addWorkspace(e),i.addTab(e),i.activateTab(n),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return e}function r(e){if(1!=i.count()){s(e);var t=RED.nodes.removeWorkspace(e.id);t.t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function t(e){var o=RED.nodes.workspace(e);RED.view.state(RED.state.EDITING);var t={title:RED._("workspace.editFlow",{name:o.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1==i.count()?" disabled":""),text:RED._("common.label.delete"),click:function(){r(o),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e=$("#node-input-name").val();if(o.label!=e){var t={t:"edit",changes:{label:o.label},node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(t),i.renameTab(o.id,e),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}RED.tray.close()}}],open:function(e){var t=e.find(".editor-tray-body"),n=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(n),$('<input type="text" style="display: none;" />').prependTo(n),n.submit(function(e){e.preventDefault()}),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT)}};RED.tray.show(t)}function s(e){e?i.contains(e.id)&&i.removeTab(e.id):r(RED.nodes.workspace(n))}function l(e){RED.nodes.setWorkspaceOrder(e.filter(function(e){return void 0!==RED.nodes.workspace(e)})),i.order(e)}return{init:function(){i=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var t={old:n};n=e.id,t.workspace=n,RED.events.emit("workspace:change",t),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh()},ondblclick:function(e){"subflow"!=e.type?t(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){RED.menu.setDisabled("menu-item-workspace-delete",1==i.count())},onremove:function(e){RED.menu.setDisabled("menu-item-workspace-delete",1==i.count())},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),l(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){a()}}),RED.events.on("sidebar:resize",i.resize),RED.menu.setAction("menu-item-workspace-delete",function(){r(RED.nodes.workspace(n))}),$(window).resize(function(){i.resize()})},add:a,remove:s,order:l,edit:function(e){t(e||n)},contains:function(e){return i.contains(e)},count:function(){return i.count()},active:function(){return n},show:function(e){if(!i.contains(e)){var t=RED.nodes.subflow(e);if(!t)return;a({type:"subflow",id:e,icon:"red/images/subflow_tab.png",label:t.name,closeable:!0})}i.activateTab(e)},refresh:function(){RED.nodes.eachWorkspace(function(e){i.renameTab(e.id,e.label)}),RED.nodes.eachSubflow(function(e){i.contains(e.id)&&i.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){i.resize()}}}(),RED.view=function(){var T,C,O=5e3,S=5e3,N=.75,h=1,L=100,P=30,g=1e3,v=0,m=[],b=0,r={},z=20,A=!1,I=!1,w=null,s=[],l=[],d=[],M=null,p=null,B=null,G=null,W=0,f=null,j=[0,0],F=null,V=0,J=[],U=null,D=!1,c=null,u=null,y=0,H=0,a="",E={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},K=d3.select("#chart").append("svg:svg").attr("width",O).attr("height",S).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){ve()}),R=K.append("svg:g").on("dblclick.zoom",null).append("svg:g").on("mousemove",_).on("mousedown",function(){B||p||(M=null,ne());if(0===V&&(U&&(U.remove(),U=null),!b)){var e=d3.mouse(this);U=R.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault()}}).on("mouseup",i).on("touchend",function(){clearTimeout(b),b=null,RED.touch.radialMenu.active()||(U&&e.attr("fill","#fff"),i.call(this))}).on("touchcancel",i).on("touchstart",function(){var e;if(1<d3.event.touches.length){clearTimeout(b),b=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,i=$("#chart").offset(),a=[$("#chart").scrollLeft(),$("#chart").scrollTop()];m=[(t.pageX+o/2-i.left+a[0])/h,(t.pageY+n/2-i.top+a[1])/h],[t.pageX+o/2,t.pageY+n/2],v=Math.sqrt(n*n+o*o)}else{var r=d3.select(document.body),s=[(e=d3.event.touches.item(0)).pageX,e.pageY];m=[e.pageX,e.pageY],v=0;d3.touches(this)[0];b=setTimeout(function(){b=null,he(r,s)},g)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(b){var t=(e=d3.event.touches.item(0)).pageX-m[0],n=e.pageY-m[1];64<Math.abs(t*t+n*n)&&(clearTimeout(b),b=null)}else U&&d3.event.preventDefault();_.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),i=e.pageY-o.pageY,a=e.pageX-o.pageX,r=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),s=Math.sqrt(i*i+a*a),l=[o.pageX+a/2,o.pageY+i/2];if(!isNaN(s)){oldScaleFactor=h,h=Math.min(2,Math.max(.3,h+Math.floor(100*s-100*v)/1e4));var d=[m[0]*(h-oldScaleFactor),m[1]*(h-oldScaleFactor)];v=s,l,$("#chart").scrollLeft(r[0]+d[0]),$("#chart").scrollTop(r[1]+d[1]),ge()}}}),e=R.append("svg:rect").attr("width",O).attr("height",S).attr("fill","#fff"),t=d3.scale.linear().range([0,O]).domain([0,O]),n=R.append("g");n.selectAll("line.horizontal").data(t.ticks(O/z)).enter().append("line").attr({class:"horizontal",x1:0,x2:O,y1:function(e){return t(e)},y2:function(e){return t(e)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),n.selectAll("line.vertical").data(t.ticks(O/z)).enter().append("line").attr({class:"vertical",y1:0,y2:O,x1:function(e){return t(e)},x2:function(e){return t(e)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),n.style("visibility","hidden");var o=R.append("g"),X=[];function Y(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=o.append("svg:path").attr("class","drag_line"),X.push(n)}}function k(){for(;X.length;)X.pop().el.remove()}function q(){var e=RED.workspaces.active();s=RED.nodes.filterNodes({z:e}),l=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function _(){var e,u;if(F=d3.touches(this)[0]||d3.mouse(this),U){var t,n,o=parseInt(U.attr("ox")),i=parseInt(U.attr("oy")),a=parseInt(U.attr("x")),r=parseInt(U.attr("y"));return t=F[0]<o?o-(a=F[0]):F[0]-a,n=F[1]<i?i-(r=F[1]):F[1]-r,void U.attr("x",a).attr("y",r).attr("width",t).attr("height",n)}if(V==RED.state.IMPORT_DRAGGING||B||null!=M){var s;if(V==RED.state.JOINING){if(0===X.length){if(d3.event.shiftKey){var l,d=[],c=[];if(M&&(0===G&&M.source===B&&M.sourcePort===W||1===G&&M.target===B))c=[M];else l=0===G?{source:B,sourcePort:W}:{target:B},c=RED.nodes.filterLinks(l);for(e=0;e<c.length;e++){var p=c[e];RED.nodes.removeLink(p),d.push({link:p,node:0===G?p.target:p.source,port:0===G?0:p.sourcePort,portType:0===G?1:0})}Y(d),V=0,q(),ge(),V=RED.state.JOINING}else Y([{node:B,port:W,portType:G}]);M=null}for(s=F,e=0;e<X.length;e++){var f=X[e],h=-((0===f.portType&&f.node.outputs||1)-1)/2*13+13*f.port,g=0===f.portType?1:-1,v=s[1]-(f.node.y+h),m=s[0]-(f.node.x+g*f.node.w/2),b=Math.sqrt(v*v+m*m),y=N,D=0;b<L&&(y=.75-(L-b)/L*.75),m*g<0&&(y+=Math.min(5*L,Math.abs(m))/(5*L)*2,Math.abs(v)<3*P&&(D=(0<v?.5:-.5)*((3*P-Math.abs(v))/(3*P))*(Math.min(L,Math.abs(m))/L))),f.el.attr("d","M "+(f.node.x+g*f.node.w/2)+" "+(f.node.y+h)+" C "+(f.node.x+g*(f.node.w/2+L*y))+" "+(f.node.y+h+D*P)+" "+(s[0]-g*y*L)+" "+(s[1]-D*P)+" "+s[0]+" "+s[1])}d3.event.preventDefault()}else if(V==RED.state.MOVING){s=d3.mouse(document.body),isNaN(s[0])&&(s=d3.touches(document.body)[0]),3<(j[0]-s[0])*(j[0]-s[0])+(j[1]-s[1])*(j[1]-s[1])&&(V=RED.state.MOVING_ACTIVE,H=0,I=!1,1===J.length&&(u=J[0],I=u.n.hasOwnProperty("_def")&&0<u.n._def.inputs&&0<u.n._def.outputs&&0===RED.nodes.filterLinks({source:u.n}).length&&0===RED.nodes.filterLinks({target:u.n}).length))}else if(V==RED.state.MOVING_ACTIVE||V==RED.state.IMPORT_DRAGGING){s=F;for(var w=0,E=0,R=O,k=S,_=0;_<J.length;_++)u=J[_],d3.event.shiftKey&&(u.n.ox=u.n.x,u.n.oy=u.n.y),u.n.x=s[0]+u.dx,u.n.y=s[1]+u.dy,u.n.dirty=!0,w=Math.min(u.n.x-u.n.w/2-5,w),E=Math.min(u.n.y-u.n.h/2-5,E),R=Math.max(u.n.x+u.n.w/2+5,R),k=Math.max(u.n.y+u.n.h/2+5,k);if(0!==w||0!==E)for(e=0;e<J.length;e++)(u=J[e]).n.x-=w,u.n.y-=E;if(R!==O||k!==S)for(e=0;e<J.length;e++)(u=J[e]).n.x-=R-O,u.n.y-=k-S;if(A!=d3.event.shiftKey&&0<J.length){var x=[0,0];if(u=J[0],x[0]=u.n.x-(z*Math.floor((u.n.x-u.n.w/2)/z)+u.n.w/2),x[1]=u.n.y-z*Math.floor(u.n.y/z),0!==x[0]||0!==x[1])for(e=0;e<J.length;e++)(u=J[e]).n.x-=x[0],u.n.y-=x[1],u.n.x==u.n.ox&&u.n.y==u.n.oy&&(u.dirty=!1)}V!=RED.state.MOVING_ACTIVE&&V!=RED.state.IMPORT_DRAGGING||1!==J.length||(u=J[0],I&&(C||(C=setTimeout(function(){var e=[],t=1/0,n=null,o=u.n.x,i=u.n.y;if(K[0][0].getIntersectionList){var a=K[0][0].createSVGRect();a.x=o,a.y=i,a.width=1,a.height=1,e=K[0][0].getIntersectionList(a,K[0][0])}else e=RED.view.getLinksAtPoint(o,i);for(var r=0;r<e.length;r++)if(d3.select(e[r]).classed("link_background"))for(var s=e[r].getTotalLength(),l=0;l<s;l+=10){var d=e[r].getPointAtLength(l),c=(d.x-o)*(d.x-o)+(d.y-i)*(d.y-i);c<200&&c<t&&(t=c,n=e[r])}T&&T!==n&&d3.select(T.parentNode).classed("link_splice",!1),n?d3.select(n.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),T=n,C=null},100))))}0!==V&&ge()}}function i(){var e,t;if(B&&V==RED.state.JOINING){var n=[];for(e=0;e<X.length;e++)X[e].link&&n.push(X[e].link);t={t:"delete",links:n,dirty:RED.nodes.dirty()},RED.history.push(t),k()}if(U){var o=parseInt(U.attr("x")),i=parseInt(U.attr("y")),a=o+parseInt(U.attr("width")),r=i+parseInt(U.attr("height"));d3.event.ctrlKey||te(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>o&&e.x<a&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,J.push({n:e})))}),w&&(w.in.forEach(function(e){e.selected=e.x>o&&e.x<a&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,J.push({n:e}))}),w.out.forEach(function(e){e.selected=e.x>o&&e.x<a&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,J.push({n:e}))})),ne(),U.remove(),U=null}else V!=RED.state.DEFAULT||null!=p||d3.event.ctrlKey||d3.event.metaKey||(te(),ne());if(V==RED.state.MOVING_ACTIVE&&0<J.length){for(var s=[],l=0;l<J.length;l++)s.push({n:J[l].n,ox:J[l].ox,oy:J[l].oy,changed:J[l].n.changed}),J[l].n.dirty=!0,J[l].n.changed=!0;if(t={t:"move",nodes:s,dirty:RED.nodes.dirty()},T){var d=d3.select(T).data()[0];RED.nodes.removeLink(d);var c={source:d.source,sourcePort:d.sourcePort,target:J[0].n},u={source:J[0].n,sourcePort:0,target:d.target};RED.nodes.addLink(c),RED.nodes.addLink(u),t.links=[c,u],t.removedLinks=[d],q()}RED.nodes.dirty(!0),RED.history.push(t)}if(V==RED.state.MOVING||V==RED.state.MOVING_ACTIVE)for(e=0;e<J.length;e++)delete J[e].ox,delete J[e].oy;V==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove(27),q(),RED.nodes.dirty(!0)),le(),ge()}function x(){h<2&&(h+=.1,ge())}function Z(){.3<h&&(h-=.1,ge())}function Q(){h=1,ge()}function ee(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e})))}),w&&(w.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e}))}),w.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e}))})),M=null,ne(),ge()}function te(){for(var e=0;e<J.length;e++){var t=J[e];t.n.dirty=!0,t.n.selected=!1}J=[],M=null}function ne(){var e={};0<J.length&&(e.nodes=J.map(function(e){return e.n})),null!=M&&(e.link=M);var t=RED.workspaces.active();l=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};d=[];for(var o=0;o<J.length;o++)if("link out"===J[o].n.type||"link in"===J[o].n.type){var i=J[o].n,a={};i.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===i.type?t.z===i.z?n[i.id+":"+t.id]||(l.push({source:i,sourcePort:0,target:t,link:!0}),n[i.id+":"+t.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)):t.z===i.z?n[t.id+":"+i.id]||(l.push({source:t,sourcePort:0,target:i,link:!0}),n[t.id+":"+i.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)))}),0<Object.keys(a).length&&d.push({refresh:Math.floor(1e4*Math.random()),node:i,links:a})}RED.events.emit("view:selection-changed",e)}function oe(){if(0<J.length){for(var e=[],t=0;t<J.length;t++)e.push({n:J[t].n,ox:J[t].ox,oy:J[t].oy,changed:J[t].n.changed}),J[t].n.changed=!0,J[t].n.dirty=!0,delete J[t].ox,delete J[t].oy;ge(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}function ie(e,t){if(0<J.length){for(var n,o=0,i=0,a=0;a<J.length;a++)null==(n=J[a]).ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),i=Math.min(n.n.y-n.n.h/2-5,i);if(0!==o||0!==i)for(var r=0;r<J.length;r++)(n=J[r]).n.x-=o,n.n.y-=i;ge()}}function ae(){if(0<J.length||null!=M){var e,t=[],n=[],o=[],i=[],a=[],r=RED.nodes.dirty();if(0<J.length){for(var s=0;s<J.length;s++){var l=J[s].n;if(l.selected=!1,"subflow"!=l.type){l.x<0&&(l.x=25);var d=RED.nodes.remove(l.id);t.push(l),t=t.concat(d.nodes),n=n.concat(d.links)}else"out"===l.direction?o.push(l):"in"===l.direction&&i.push(l),l.dirty=!0}0<o.length&&(e=RED.subflow.removeOutput(o))&&(n=n.concat(e.links)),1==i.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var c=RED.subflow.refresh(!0);c&&(a=c.instances),J=[],(0<t.length||0<o.length||0<i.length)&&RED.nodes.dirty(!0)}M&&(RED.nodes.removeLink(M),n.push(M),RED.nodes.dirty(!0));var u={t:"delete",nodes:t,links:n,subflowOutputs:o,subflowInputs:i,subflow:{instances:a},dirty:r};RED.history.push(u),M=null,q(),ne(),ge()}}function re(){if(0<J.length){for(var e=[],t=0;t<J.length;t++){var n=J[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var i=RED.nodes.node(n[o]);i&&i._def.exclusive&&e.push(RED.nodes.convertNode(i))}e.push(RED.nodes.convertNode(n))}}a=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function se(e,t,n){var o=document.createElement("span");o.className=t,o.style.position="absolute",o.style.top="-1000px",o.innerHTML=(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.body.appendChild(o);var i=o.offsetWidth;return document.body.removeChild(o),n+i}function le(){G=V=0,T=p=f=B=null,I=!1,d3.select(".link_splice").classed("link_splice",!1),C&&(clearTimeout(C),C=null)}function de(e,t,n){B=e,V=RED.state.JOINING,G=t,W=n||0,document.body.style.cursor="crosshair",d3.event.preventDefault()}function ce(e,o,i){var t;if(document.body.style.cursor="",V==RED.state.JOINING&&0<X.length){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var t=e.w/2,n=e.h/2;e.x-t<F[0]&&e.x+t>F[0]&&e.y-n<F[1]&&e.y+n>F[1]&&(o=0<(f=e).inputs?1:0,i=0)}}):f=e;var n=[],a=[];for(t=0;t<X.length;t++)X[t].link&&a.push(X[t].link);for(t=0;t<X.length;t++)if(o!=X[t].portType&&f!==X[t].node){var r,s,l,d=X[t];if(0===d.portType?(r=d.node,l=d.port,s=f):1==d.portType&&(r=f,s=d.node,l=i),!(0!==RED.nodes.filterLinks({source:r,target:s,sourcePort:l}).length)){var c={source:r,sourcePort:l,target:s};RED.nodes.addLink(c),n.push(c)}}if(0<n.length||0<a.length){var u={t:"add",links:n,removedLinks:a,dirty:RED.nodes.dirty()};if(w){var p=RED.subflow.refresh(!0);p&&(u.subflow={id:w.id,changed:w.changed,instances:p.instances})}RED.history.push(u),q(),RED.nodes.dirty(!0)}le(),k(),M=null,ge()}}function ue(e){if(u&&B==e&&0<H&&H<750)return V=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(w),H=0,void d3.event.stopPropagation();ce(e,e._def?0<e.inputs?1:0:"in"==e.direction?0:1,0)}function pe(e){if(ve(),V==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove(27),T){var t=d3.select(T).data()[0];RED.nodes.removeLink(t);var n={source:t.source,sourcePort:t.sourcePort,target:J[0].n},o={source:J[0].n,sourcePort:0,target:t.target};RED.nodes.addLink(n),RED.nodes.addLink(o);var i=RED.history.peek();i.links=[n,o],i.removedLinks=[t],q()}return ne(),RED.nodes.dirty(!0),ge(),le(),void d3.event.stopPropagation()}B=e;var a,r=Date.now();if(H=r-y,y=r,u=c==B,c=B,e.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(B.selected=!1,a=0;a<J.length;a+=1)if(J[a].n===B){J.splice(a,1);break}}else{if(d3.event.shiftKey){te();for(var s=RED.nodes.getAllFlowNodes(B),l=0;l<s.length;l++)s[l].selected=!0,s[l].dirty=!0,J.push({n:s[l]})}else e.selected||(d3.event.ctrlKey||d3.event.metaKey||te(),B.selected=!0,J.push({n:B}));if(M=null,2!=d3.event.button){V=RED.state.MOVING;var d=d3.touches(this)[0]||d3.mouse(this);for(d[0]+=e.x-e.w/2,d[1]+=e.y-e.h/2,a=0;a<J.length;a++)J[a].ox=J[a].n.x,J[a].oy=J[a].n.y,J[a].dx=J[a].n.x-d[0],J[a].dy=J[a].n.y-d[1];j=d3.mouse(document.body),isNaN(j[0])&&(j=d3.touches(document.body)[0])}}e.dirty=!0,ne(),ge(),d3.event.stopPropagation()}function fe(t){if(w||t.changed)t.changed?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.undeployedChanges")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(t._def.button.toggle&&(t[t._def.button.toggle]=!t[t._def.button.toggle],t.dirty=!0),t._def.button.onclick)try{t._def.button.onclick.call(t)}catch(e){console.log("Definition error: "+t.type+".onclick",e)}t.dirty&&ge()}d3.event.preventDefault()}function he(e,t){var n=B,o=[];o.push({name:"delete",disabled:0===J.length&&null===M,onselect:function(){ae()}}),o.push({name:"cut",disabled:0===J.length,onselect:function(){re(),ae()}}),o.push({name:"copy",disabled:0===J.length,onselect:function(){re()}}),o.push({name:"paste",disabled:0===a.length,onselect:function(){me(a,!1,!0)}}),o.push({name:"edit",disabled:1!=J.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){ee()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),le()}function ge(){if(R.attr("transform","scale("+h+")"),K.attr("width",O*h).attr("height",S*h),V!=RED.state.JOINING){var y={};if(w){var e=R.selectAll(".subflowoutput").data(w.out,function(e,t){return e.id});e.exit().remove();var t=e.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});t.each(function(e,t){e.w=40,e.h=40}),t.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",ue).on("mousedown",pe).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){he(t,o)},g),pe.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ue.call(this,e)}),t.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).attr("x",-5).attr("y",15).on("mousedown",function(e,t){de(e,1,0)}).on("touchstart",function(e,t){de(e,1,0)}).on("mouseup",function(e,t){ce(e,1,0)}).on("touchend",function(e,t){ce(e,1,0)}).on("mouseover",function(e,t){d3.select(this).classed("port_hovered",V!=RED.state.JOINING||0<X.length&&1!==X[0].portType)}).on("mouseout",function(e,t){d3.select(this).classed("port_hovered",!1)}),t.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),t.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var n=R.selectAll(".subflowinput").data(w.in,function(e,t){return e.id});n.exit().remove();var o=n.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});o.each(function(e,t){e.w=40,e.h=40}),o.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",ue).on("mousedown",pe).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){he(t,o)},g),pe.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ue.call(this,e)}),o.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).attr("x",35).attr("y",15).on("mousedown",function(e,t){de(e,0,t)}).on("touchstart",function(e,t){de(e,0,t)}).on("mouseup",function(e,t){ce(e,0,t)}).on("touchend",function(e,t){ce(e,0,t)}).on("mouseover",function(e,t){d3.select(this).classed("port_hovered",V!=RED.state.JOINING||0<X.length&&0!==X[0].portType)}).on("mouseout",function(e,t){d3.select(this).classed("port_hovered",!1)}),o.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),e.each(function(e,t){if(e.dirty){var n=d3.select(this);n.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),n.selectAll(".port_index").text(function(e){return e.i+1}),n.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(y[e.id]=e).dirty=!1}}),n.each(function(e,t){if(e.dirty){var n=d3.select(this);n.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),n.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(y[e.id]=e).dirty=!1}})}else R.selectAll(".subflowoutput").remove(),R.selectAll(".subflowinput").remove();var i=R.selectAll(".nodegroup").data(s,function(e){return e.id});i.exit().remove(),i.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=w}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(t,e){var n=d3.select(this),o="link in"===t.type||"link out"===t.type;n.attr("id",t.id);var i=t._def.label;try{i=("function"==typeof i?i.call(t):i)||""}catch(e){console.log("Definition error: "+t.type+".label",e),i=t.type}if(t.w=o?P:Math.max(L,z*Math.ceil((se(i,"node_label",50)+(0<t._def.inputs?7:0))/z)),t.h=Math.max(P,15*(t.outputs||0)),t._def.badge){var a=n.append("svg:g").attr("class","node_badge_group"),r=a.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);a.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(t._def.badge()),t._def.onbadgeclick&&r.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(t._def.button){var s=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});s.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",P-4).attr("fill","#eee"),s.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",P-12).attr("fill",function(e){return e._def.color}).attr("cursor","pointer").on("mousedown",function(e){U||e.changed||(ve(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){U||e.changed||(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){U||e.changed||d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!U&&!e.changed){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",fe).on("touchstart",fe)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return e._def.color}).on("mouseup",ue).on("mousedown",pe).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];m=[n.pageX,n.pageY],v=0,b=setTimeout(function(){he(t,o)},g),pe.call(this,e)}).on("touchend",function(e){clearTimeout(b),b=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():ue.call(this,e)}).on("mouseover",function(e){0===V&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(t._def.icon){var l=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),d=(l.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),l.append("image").attr("xlink:href","icons/"+t._def.icon).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),c=l.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==t._def.align&&(l.attr("class","node_icon_group node_icon_group_"+t._def.align),c.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var u=new Image;u.src="icons/"+t._def.icon,u.onload=function(){d.attr("width",Math.min(u.width,30)),d.attr("height",Math.min(u.height,30)),d.attr("x",15-Math.min(u.width,30)/2)},l.style("pointer-events","none")}if(!o){var p=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");t._def.align&&(p.attr("class","node_label node_label_"+t._def.align),"right"===t._def.align&&p.attr("text-anchor","end"));var f=n.append("svg:g").attr("class","node_status_group").style("display","none");f.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),f.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9)}n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),i.each(function(t,e){if(t.dirty){var n="link in"===t.type||"link out"===t.type;if(y[t.id]=t,!n&&t.resize){var o=t._def.label;try{o=("function"==typeof o?o.call(t):o)||""}catch(e){console.log("Definition error: "+t.type+".label",e),o=t.type}var i=t.w;t.w=Math.max(L,z*Math.ceil((se(o,"node_label",50)+(0<t._def.inputs?7:0))/z)),t.h=Math.max(P,15*(t.outputs||0)),t.x+=(t.w-i)/2,t.resize=!1}var a=d3.select(this);if(a.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),V!=RED.state.MOVING_ACTIVE){a.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),a.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),a.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var r=a.selectAll(".port_input");if(0!==t.inputs||r.empty()){if(1===t.inputs&&r.empty()){a.append("g").attr("class","port_input").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e){de(e,1,0)}).on("touchstart",function(e){de(e,1,0)}).on("mouseup",function(e){ce(e,1,0)}).on("touchend",function(e){ce(e,1,0)}).on("mouseover",function(e){d3.select(this).classed("port_hovered",V!=RED.state.JOINING||0<X.length&&1!==X[0].portType)}).on("mouseout",function(e){d3.select(this).classed("port_hovered",!1)})}}else r.remove();var s=t.outputs,l=t.h/2-(s-1)/2*13;if(t.ports=t.ports||d3.range(s),t._ports=a.selectAll(".port_output").data(t.ports),t._ports.enter().append("g").attr("class","port_output").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(b=t,function(e,t){de(b,0,t)})).on("touchstart",(m=t,function(e,t){de(m,0,t)})).on("mouseup",(v=t,function(e,t){ce(v,0,t)})).on("touchend",(g=t,function(e,t){ce(g,0,t)})).on("mouseover",function(e,t){d3.select(this).classed("port_hovered",V!=RED.state.JOINING||0<X.length&&0!==X[0].portType)}).on("mouseout",function(e,t){d3.select(this).classed("port_hovered",!1)}),t._ports.exit().remove(),t._ports){s=t.outputs||1,l=t.h/2-(s-1)/2*13;var d=t.w-5;t._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+d+","+(l+13*t-5)+")"})})}if(a.selectAll("text.node_label").text(function(t,e){var n="";if(t._def.label){n=t._def.label;try{n=("function"==typeof n?n.call(t):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(e){console.log("Definition error: "+t.type+".label",e),n=t.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(t){var n="";if(t._def.labelStyle){n=t._def.labelStyle;try{n=("function"==typeof n?n.call(t):n)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),n=""}n=" "+n}return"node_label"+(t._def.align?" node_label_"+t._def.align:"")+n}),t._def.icon){icon=a.select(".node_icon");var c,u=icon.attr("xlink:href");if("function"==typeof t._def.icon)try{c=t._def.icon.call(t)}catch(e){console.log("icon",e),c="arrow-in.png"}else c=t._def.icon;if("icons/"+c!=u){icon.attr("xlink:href","icons/"+c);var p=new Image;p.src="icons/"+t._def.icon,p.onload=function(){icon.attr("width",Math.min(p.width,30)),icon.attr("height",Math.min(p.height,30)),icon.attr("x",15-Math.min(p.width,30)/2)}}}a.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),a.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!e.changed}),a.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed?13:0)}).classed("hidden",function(e){return e.valid}),a.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),a.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),a.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),a.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),a.selectAll(".node_button").attr("opacity",function(e){return w||e.changed?.4:1}),a.selectAll(".node_button_button").attr("cursor",function(e){return w||e.changed?"":"pointer"}),a.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),a.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),a.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),a.selectAll("text.node_badge_label").text(function(t,e){if(t._def.badge){if("function"!=typeof t._def.badge)return t._def.badge;try{return t._def.badge.call(t)}catch(e){return console.log("Definition error: "+t.type+".badge",e),""}}return""})}if(D&&t.status){a.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(t.h+3)+")");var f,h=E[t.status.fill];if(null==t.status.shape&&null==h)a.selectAll(".node_status").style("display","none");else null==t.status.shape||"dot"==t.status.shape?f={display:"inline",fill:h,stroke:h}:"ring"==t.status.shape&&(f={display:"inline",fill:"#fff",stroke:h}),a.selectAll(".node_status").style(f);t.status.text?a.selectAll(".node_status_label").text(t.status.text):a.selectAll(".node_status_label").text("")}else a.selectAll(".node_status_group").style("display","none");t.dirty=!1}var g,v,m,b});var a=R.selectAll(".link").data(l,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});a.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){p=e,te(),M=p,ne(),ge(),ve(),d3.event.stopPropagation()}).on("touchstart",function(e){p=e,te(),M=p,ne(),ge(),ve(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];b=setTimeout(function(){b=null,he(t,o)},g)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&w})}),a.exit().remove(),R.selectAll(".link_path").each(function(e){var t=d3.select(this);(e.added||e===M||e.selected||y[e.source.id]||y[e.target.id])&&t.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0),n=e.target.y-(e.source.y+t),o=e.target.x-e.target.w/2-(e.source.x+e.source.w/2),i=Math.sqrt(n*n+o*o),a=N,r=0;return i<L&&(a=.75-(L-i)/L*.75),o<0&&(a+=Math.min(5*L,Math.abs(o))/(5*L)*2,Math.abs(n)<3*P&&(r=(0<n?.5:-.5)*((3*P-Math.abs(n))/(3*P))*(Math.min(L,Math.abs(o))/L))),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,"M "+(e.source.x+e.source.w/2)+" "+(e.source.y+t)+" C "+(e.source.x+e.source.w/2+a*L)+" "+(e.source.y+t+r*P)+" "+(e.target.x-e.target.w/2-a*L)+" "+(e.target.y-r*P)+" "+(e.target.x-e.target.w/2)+" "+e.target.y})}),a.classed("link_selected",function(e){return e===M||e.selected}),a.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var r=R.selectAll(".link_flow_link_g").data(d,function(e){return e.node.id+":"+e.refresh});r.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(n,e){var t=d3.select(this),i=1,a="start";"link in"===n.node.type&&(i=-1,a="end");var r=30*i,s=20*i,o=(t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+r),n.links),l=Object.keys(o),d=RED.nodes.getWorkspaceOrder();l.sort(function(e,t){return d.indexOf(e)-d.indexOf(t)});var c=P,u=-(l.length-1)*c/2,p=t.selectAll(".link_group").data(l);p.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(e){d3.event.stopPropagation();var t=n.links[e];RED.workspaces.show(e),t.forEach(function(e){e.selected=!0,e.dirty=!0,J.push({n:e})}),ne(),ge()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+r+" 0 C "+(r+1.7*s)+" 0 "+(r+.1*s)+" "+u+" "+(r+1.5*s)+" "+u+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(r+1.5*s+17*i)+" "+(u-12)+" h "+10*-i+" a 3 3 45 0 "+(1===i?"0":"1")+" "+-3*i+" 3 v 18 a 3 3 45 0 "+(1===i?"0":"1")+" "+3*i+" 3 h "+10*i),t.append("svg:path").attr("class","link_port").attr("d","M "+(r+1.5*s+20*i)+" "+(u-12)+" h "+30*i+" M "+(r+1.5*s+20*i)+" "+(u+12)+" h "+30*i).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",r+1.5*s-4+4*i).attr("y",u-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",r+1.5*s-(-1===i?L:0)).attr("y",u-12).attr("width",L).attr("height",24).style("stroke","none").style("fill","transparent");var n,o=RED.nodes.workspace(e);o&&(n=o.label||o.id),t.append("svg:text").attr("class","port_label").attr("x",r+1.5*s+15*i).attr("y",u+1).style("font-size","10px").style("text-anchor",a).text(n),u+=c}),p.exit().remove()}),r.exit().remove(),(r=R.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else R.selectAll(".link_selected").data(l,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function ve(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function me(e,t,n){try{var o;w&&(o=w.changed);var i=RED.nodes.import(e,!0,t);if(i){var a=i[0],r=i[1],s=i[2],l=i[3],d=i[4];t&&d&&RED.workspaces.show(d.id);var c=a.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),u=a.map(function(e){return e.id});if(0<c.length){var p=c[0].n,f=p.x,h=p.y;null==F&&(F=[0,0]);var g,v,m=0,b=0;for(g=0;g<c.length;g++)(v=c[g]).n.selected=!0,v.n.changed=!0,v.n.x-=f-F[0],v.n.y-=h-F[1],v.dx=v.n.x-F[0],v.dy=v.n.y-F[1],m=Math.min(v.n.x-L/2-5,m),b=Math.min(v.n.y-P/2-5,b);for(g=0;g<c.length;g++)if((v=c[g]).n.x-=m,v.n.y-=b,v.dx-=m,v.dy-=b,v.n._def.onadd)try{v.n._def.onadd.call(v.n)}catch(e){console.log("onadd:",e)}n||(V=RED.state.IMPORT_DRAGGING,I=!1,1===c.length&&(v=c[0],I=v.n.hasOwnProperty("_def")&&0<v.n._def.inputs&&0<v.n._def.outputs)),RED.keyboard.add("*",27,function(){RED.keyboard.remove(27),te(),RED.history.pop(),V=0}),te(),J=c}var y={t:"add",nodes:u,links:r,workspaces:s,subflows:l,dirty:RED.nodes.dirty()};if(0===c.length&&RED.nodes.dirty(!0),w){var D=RED.subflow.refresh(!0);D&&(y.subflow={id:w.id,changed:o,instances:D.instances})}RED.history.push(y),q(),ge()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){var t=$("#chart");0!==e.old&&(r[e.old]={left:t.scrollLeft(),top:t.scrollTop()});var n=t.scrollLeft(),o=t.scrollTop();w=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",w),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||w),r[e.workspace]?(t.scrollLeft(r[e.workspace].left),t.scrollTop(r[e.workspace].top)):(t.scrollLeft(0),t.scrollTop(0));var i=t.scrollLeft()-n,a=t.scrollTop()-o;null!=F&&(F[0]+=i,F[1]+=a),te(),RED.nodes.eachNode(function(e){e.dirty=!0}),ne(),q(),ge()}),$("#btn-zoom-out").click(function(){Z()}),$("#btn-zoom-zero").click(function(){Q()}),$("#btn-zoom-in").click(function(){x()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?Z():x())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=t.draggable[0].type,o=/^subflow:(.+)$/.exec(n);if(w&&o){if(o[1]===w.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],w.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var i={id:RED.nodes.id(),z:RED.workspaces.active()};if(i.type=n,i._def=RED.nodes.getType(i.type),o){var a=RED.nodes.subflow(o[1]);i.inputs=a.in.length,i.outputs=a.out.length}else{for(var r in i.inputs=i._def.inputs||0,i.outputs=i._def.outputs,i._def.defaults)i._def.defaults.hasOwnProperty(r)&&void 0!==i._def.defaults[r].value&&(i[r]=JSON.parse(JSON.stringify(i._def.defaults[r].value)));if(i._def.onadd)try{i._def.onadd.call(i)}catch(e){console.log("onadd:",e)}}i.changed=!0,i.w=L,i.h=Math.max(P,15*(i.outputs||0));var s={t:"add",nodes:[i.id],dirty:RED.nodes.dirty()};if(w){var l=RED.subflow.refresh(!0);l&&(s.subflow={id:w.id,changed:w.changed,instances:l.instances})}var d=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),c=d3.touches(this)[0]||d3.mouse(this);c[1]+=this.scrollTop+(i.h/2-d[1]),c[0]+=this.scrollLeft+(i.w/2-d[0]),c[1]/=h,c[0]/=h,A&&(c[0]=z*Math.ceil(c[0]/z),c[1]=z*Math.ceil(c[1]/z)),i.x=c[0],i.y=c[1];var u=$(t.helper).data("splice");if(u){RED.nodes.removeLink(u);var p={source:u.source,sourcePort:u.sourcePort,target:i},f={source:i,sourcePort:0,target:u.target};RED.nodes.addLink(p),RED.nodes.addLink(f),s.links=[p,f],s.removedLinks=[u]}RED.history.push(s),RED.nodes.add(i),RED.editor.validateNode(i),RED.nodes.dirty(!0),te(),i.selected=!0,J.push({n:i}),q(),ne(),ge(),i._def.autoedit&&RED.editor.edit(i)}}),RED.keyboard.add("workspace",8,function(){ae(),d3.event.preventDefault()}),RED.keyboard.add("workspace",46,function(){ae(),d3.event.preventDefault()}),RED.keyboard.add("workspace",67,{ctrl:!0},function(){re(),d3.event.preventDefault()}),RED.keyboard.add("workspace",88,{ctrl:!0},function(){re(),ae(),d3.event.preventDefault()}),RED.keyboard.add("workspace",90,{ctrl:!0},function(){RED.history.pop()}),RED.keyboard.add("workspace",65,{ctrl:!0},function(){ee(),d3.event.preventDefault()}),RED.keyboard.add("*",187,{ctrl:!0},function(){x(),d3.event.preventDefault()}),RED.keyboard.add("*",189,{ctrl:!0},function(){Z(),d3.event.preventDefault()}),RED.keyboard.add("*",48,{ctrl:!0},function(){Q(),d3.event.preventDefault()}),RED.keyboard.add("workspace",86,{ctrl:!0},function(){me(a),d3.event.preventDefault()}),RED.keyboard.add("workspace",38,function(){ie(0,-1),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",38,{shift:!0},function(){ie(0,-20),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",40,function(){ie(0,1),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",40,{shift:!0},function(){ie(0,20),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",37,function(){ie(-1,0),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",37,{shift:!0},function(){ie(-20,0),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",39,function(){ie(1,0),d3.event.preventDefault()},oe),RED.keyboard.add("workspace",39,{shift:!0},function(){ie(20,0),d3.event.preventDefault()},oe)},state:function(e){if(null==e)return V;V=e},redraw:function(e){e&&(q(),ne()),ge()},focus:ve,importNodes:me,status:function(e){if(null==e)return D;D=e,RED.nodes.eachNode(function(e){e.dirty=!0}),ge()},calculateTextWidth:se,select:function(e){if(void 0!==e&&(te(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,J=[{n:t}])}ne(),ge()},selection:function(){var e={};return 0<J.length&&(e.nodes=J.map(function(e){return e.n})),null!=M&&(e.link=M),e},toggleShowGrid:function(e){e?n.style("visibility","visible"):n.style("visibility","hidden")},toggleSnapGrid:function(e){A=e,ge()},scale:function(){return h},getLinksAtPoint:function(e,t){for(var n=[],o=K.selectAll(".link_background")[0],i=0;i<o.length;i++){var a=o[i].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&n.push(o[i])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z),RED.view.redraw();var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var i="-="+(o[0]-t.x+n[0]/2),a="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:i,scrollTop:a},200)}var r=22,s=function(){r--,t.highlighted=!t.highlighted,t.dirty=!0,RED.view.redraw(),0<=r&&setTimeout(s,100)};s()}else"config"===t._def.category&&RED.sidebar.config.show(e)}}}}(),RED.sidebar=function(){var a=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},minimumActiveTabWidth:110}),r={};var s={};function e(e){e?($("#main-container").removeClass("sidebar-closed"),a.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function l(e){e&&(t(e)||a.addTab(r[e]),a.activateTab(e),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function t(e){return a.contains(e)}return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){s.closing=!1,s.opening=!1;var n=$(window).width();if(s.start=t.position.left,s.chartWidth=$("#workspace").width(),s.chartRight=n-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){s.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}s.width=$("#sidebar").width()},drag:function(e,t){var n=t.position.left-s.start,o=s.width-n;s.opening&&(o-=3),150<o&&s.chartWidth+n<200&&(t.position.left=200+s.start-s.chartWidth,n=t.position.left-s.start,o=s.width-n),o<150?(s.closing||($("#sidebar").addClass("closing"),s.closing=!0),s.opening||(o=150,t.position.left=s.width-(150-s.start),n=t.position.left-s.start)):150<o&&(s.closing||s.opening)&&(s.closing=!1,$("#sidebar").removeClass("closing"));var i=s.chartRight-n;$("#workspace").css("right",i),$("#editor-stack").css("right",i+1),$("#sidebar").width(o),a.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){s.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.keyboard.add("*",32,{ctrl:!0},function(){RED.menu.setSelected("menu-item-sidebar",!RED.menu.isSelected("menu-item-sidebar")),d3.event.preventDefault()}),l(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&e()},addTab:function(e,t,n,o){var i;"string"==typeof e?i={id:t.id,label:e,name:e,content:t,closeable:n,visible:o}:"object"==typeof e&&(i=e),i.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),i.wrapper.append(i.content),i.wrapper.hide(),i.enableOnEdit||(i.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(i.wrapper)),i.toolbar&&($("#sidebar-footer").append(i.toolbar),$(i.toolbar).hide()),i.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+i.id,label:i.name,onselect:function(){l(i.id)},group:"sidebar-tabs"}),!1!==(r[i.id]=i).visible&&a.addTab(r[i.id])},removeTab:function(e){a.removeTab(e),$(r[e].wrapper).remove(),r[e].footer&&r[e].footer.remove(),delete r[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:l,containsTab:t,toggleSidebar:e}}(),RED.palette=function(){var D=["config","unknown","deprecated"],w=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],E={};function R(t,e){e=e||t.replace("_"," ");var n=$('<div id="palette-container-'+t+'" class="palette-category palette-close hide"><div id="palette-header-'+t+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+e+'</span></div><div class="palette-content" id="palette-base-category-'+t+'"><div id="palette-'+t+'-input"></div><div id="palette-'+t+'-output"></div><div id="palette-'+t+'-function"></div></div></div>').appendTo("#palette-container");E[t]={container:n,close:function(){n.removeClass("palette-open"),n.addClass("palette-closed"),$("#palette-base-category-"+t).slideUp(),$("#palette-header-"+t+" i").removeClass("expanded")},open:function(){n.addClass("palette-open"),n.removeClass("palette-closed"),$("#palette-base-category-"+t).slideDown(),$("#palette-header-"+t+" i").addClass("expanded")},toggle:function(){n.hasClass("palette-open")?E[t].close():E[t].open()}},$("#palette-header-"+t).on("click",function(e){E[t].toggle()})}function k(t,e,n,o){for(var i=n.split(/[ -]/),a=[],r=i[0],s=(RED.view.calculateTextWidth(r,"palette_label",0),1);s<i.length;s++){var l=RED.view.calculateTextWidth(r+" "+i[s],"palette_label",0);l<82?(r+=" "+i[s],l):(a.push(r),r=i[s],RED.view.calculateTextWidth(r,"palette_label",0))}a.push(r);var d,c=a.join("<br/>"),u=8+20*a.length;e.css({height:u+"px"}),e.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),e.find(".palette_port").css({top:u/2-5+"px"});try{var p="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=t&&(p="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+t+"</i></p>"),d=$(p+(o||($("script[data-help-name$='"+t+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&0<this.textContent.trim().length}).slice(0,2)}catch(e){console.log("Error generating pop-over label for ",t),console.log(e.toString()),d="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}e.data("popover").setContent(d)}function _(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function n(t,n){var e=_(t);if(!$("#palette_node_"+e).length&&-1===D.indexOf(n.category)){var o=n.category.replace(" ","_"),i=o.split("-")[0],a=document.createElement("div");a.id="palette_node_"+e,a.type=t;var r=/^(.*?)([ -]in|[ -]out)?$/.exec(t)[1];if(void 0!==n.paletteLabel)try{r=("function"==typeof n.paletteLabel?n.paletteLabel.call(n):n.paletteLabel)||""}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==n.align?" palette_label_right":"")}).appendTo(a),a.className="palette_node",n.icon){var s="arrow-in.png";try{s="function"==typeof n.icon?n.icon.call({}):n.icon}catch(e){console.log("Definition error: "+t+".icon",e)}var l=$("<div/>",{class:"palette_icon_container"+("right"==n.align?" palette_icon_container_right":"")}).appendTo(a);$("<div/>",{class:"palette_icon",style:"background-image: url(icons/"+s+")"}).appendTo(l)}if(a.style.backgroundColor=n.color,0<n.outputs){var d=document.createElement("div");d.className="palette_port palette_port_output",a.appendChild(d)}if(0<n.inputs){var c=document.createElement("div");c.className="palette_port palette_port_input",a.appendChild(c)}if(0===$("#palette-base-category-"+i).length)if(-1!==w.indexOf(i))R(i,RED._("node-red:palette.label."+i,{defaultValue:i}));else{var u=n.set.id;R(i,RED._(u+":palette.label."+i,{defaultValue:i}))}$("#palette-container-"+i).show(),0===$("#palette-"+o).length&&$("#palette-base-category-"+i).append('<div id="palette-'+o+'"></div>'),$("#palette-"+o).append(a),a.onmousedown=function(e){e.preventDefault()},RED.popover.create({target:$(a),content:"hi",delay:{show:750,hide:50}}),$(a).click(function(){RED.view.focus();var e='<div class="node-help">'+(0===t.indexOf("subflow:")?marked(RED.nodes.subflow(t.substring(8)).info||""):$("script[data-help-name$='"+a.type+"']").html()||"")+"</div>";RED.sidebar.info.set(e)});var p,f,h,g,v=$("#chart"),m=v.offset(),b=$("#chart>svg").get(0);$(a).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),g&&(clearTimeout(g),g=null)},drag:function(e,d){d.position.left+=17.5,0<n.inputs&&0<n.outputs&&(f=d.position.left+d.helper.width()/2-m.left+v.scrollLeft(),h=d.position.top+d.helper.height()/2-m.top+v.scrollTop(),g||(g=setTimeout(function(){var e=[],t=1/0,n=null;if(b.getIntersectionList){var o=b.createSVGRect();o.x=f,o.y=h,o.width=1,o.height=1,e=b.getIntersectionList(o,b),f/=RED.view.scale(),h/=RED.view.scale()}else f/=RED.view.scale(),h/=RED.view.scale(),e=RED.view.getLinksAtPoint(f,h);for(var i=0;i<e.length;i++)if(d3.select(e[i]).classed("link_background"))for(var a=e[i].getTotalLength(),r=0;r<a;r+=10){var s=e[i].getPointAtLength(r),l=(s.x-f)*(s.x-f)+(s.y-h)*(s.y-h);l<200&&l<t&&(t=l,n=e[i])}p&&p!==n&&d3.select(p.parentNode).classed("link_splice",!1),n?d3.select(n.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),p!==n&&(n?$(d.helper).data("splice",d3.select(n).data()[0]):$(d.helper).removeData("splice")),p=n,g=null},200)))}});var y=null;"subflows"==n.category&&($(a).dblclick(function(e){RED.workspaces.show(t.substring(8)),e.preventDefault()}),y=marked(n.info||"")),k(t,$(a),r,y),1===$("#palette-container-"+o).find(".palette_node").length&&E[o].open()}}function o(e){var t=_(e),n=$("#palette_node_"+t),o=n.closest(".palette-category");n.remove(),0===o.find(".palette_node").length&&o.find("i").hasClass("expanded")&&(o.find(".palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function i(e){var t=_(e);$("#palette_node_"+t).hide()}function a(e){var t=_(e);$("#palette_node_"+t).show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);n(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){o(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){a(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){for(var t=0;t<e.types.length;t++){i(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){o(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(o){var i=new RegExp(o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var e in $("#palette-container .palette_node").each(function(e,t){var n=$(t).find(".palette_label").text();""===o||i.test(t.id)||i.test(n)?$(this).show():$(this).hide()}),E)E.hasOwnProperty(e)&&(0===E[e].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?E[e].close():E[e].open())}($(this).val())}});var e=w;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=w),e.forEach(function(e){R(e,RED._("palette.label."+e,{defaultValue:e}))}),$("#palette-collapse-all").on("click",function(e){for(var t in e.preventDefault(),E)E.hasOwnProperty(t)&&E[t].close()}),$("#palette-expand-all").on("click",function(e){for(var t in e.preventDefault(),E)E.hasOwnProperty(t)&&E[t].open()})},add:n,remove:o,hide:i,show:a,refresh:function(){RED.nodes.eachSubflow(function(e){var t=$("#palette_node_subflow_"+e.id.replace(".","_")),n=t.find(".palette_port_input"),o=t.find(".palette_port_output");if(0===n.length&&0<e.in.length){var i=document.createElement("div");i.className="palette_port palette_port_input",t.append(i)}else 0!==n.length&&0===e.in.length&&n.remove();if(0===o.length&&0<e.out.length){var a=document.createElement("div");a.className="palette_port palette_port_output",t.append(a)}else 0!==o.length&&0===e.out.length&&o.remove();k(e.type+":"+e.id,t,e.name,marked(e.info||""))})}}}(),RED.sidebar.info=function(){marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var f=document.createElement("div");f.style.paddingTop="4px",f.style.paddingLeft="4px",f.style.paddingRight="4px";var h=!(f.className="sidebar-node-info");function g(e,t){if(""===e)return t;var n=typeof t;return $.isArray(t)?"[array:"+t.length+"]":"object"===n?"[object]":"string"===n&&30<t.length?t.substring(0,30)+" ...":t}function o(e){var t='<table class="node-info"><tbody>';t+='<tr class="blank"><td colspan="2">'+RED._("sidebar.info.node")+"</td></tr>","subflow"!=e.type&&e.name&&(t+="<tr><td>"+RED._("common.label.name")+'</td><td>&nbsp;<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'">'+e.name+"</span></td></tr>"),t+="<tr><td>"+RED._("sidebar.info.type")+"</td><td>&nbsp;"+e.type+"</td></tr>",t+="<tr><td>"+RED._("sidebar.info.id")+"</td><td>&nbsp;"+e.id+"</td></tr>";var n,o=/^subflow(:(.+))?$/.exec(e.type);if(o){n=o[2]?RED.nodes.subflow(o[2]):e,t+='<tr class="blank"><td colspan="2">'+RED._("sidebar.info.subflow")+"</td></tr>";var i=0,a="subflow:"+n.id;RED.nodes.eachNode(function(e){e.type===a&&i++}),t+="<tr><td>"+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n.name)+'">'+n.name+"</span></td></tr>",t+="<tr><td>"+RED._("sidebar.info.instances")+"</td><td>"+i+"</td></tr>"}if(!o&&"subflow"!=e.type&&"comment"!=e.type&&(t+='<tr class="blank"><td colspan="2"><a href="#" class="node-info-property-header"><i style="width: 10px; text-align: center;" class="fa fa-caret-'+(h?"down":"right")+'"></i> '+RED._("sidebar.info.properties")+"</a></td></tr>",e._def))for(var r in e._def.defaults)if("name"!=r&&e._def.defaults.hasOwnProperty(r)){var s=e[r],l=typeof s;if(null==s)s='<span style="font-style: italic; color: #ccc;">'+RED._("sidebar.info.null")+"</span>";else if("string"===l)0===s.length?s='<span style="font-style: italic; color: #ccc;">'+RED._("sidebar.info.blank")+"</span>":(30<s.length&&(s=s.substring(0,30)+" ..."),s=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));else if("number"===l)s=s.toString();else if($.isArray(s)){s="[<br/>";for(var d=0;d<Math.min(e[r].length,10);d++){s+="&nbsp;"+d+": "+JSON.stringify(e[r][d],g," ").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"<br/>"}10<e[r].length&&(s+="&nbsp;... "+RED._("sidebar.info.arrayItems",{count:e[r].length})+"<br/>"),s+="]"}else s=(s=JSON.stringify(s,g," ")).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");t+='<tr class="node-info-property-row'+(h?"":" hide")+'"><td>'+r+"</td><td>"+s+"</td></tr>"}if(t+="</tbody></table><hr/>",!n&&"comment"!=e.type){var c=$("script[data-help-name$='"+e.type+"']").html()||"";t+='<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(c)+'">'+c+"</span></div>"}if(n)t+='<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n.info||"")+'">'+marked(n.info||"")+"</span></div>";else if(e._def&&e._def.info){var u=e._def.info,p="function"==typeof u?u.call(e):u;t+='<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(p)+'">'+marked(p)+"</span></div>"}$(f).html(t),$(".node-info-property-header").click(function(e){var t=$(this).find("i");t.hasClass("fa-caret-right")?(t.removeClass("fa-caret-right"),t.addClass("fa-caret-down"),$(".node-info-property-row").show(),h=!0):(t.addClass("fa-caret-right"),t.removeClass("fa-caret-down"),$(".node-info-property-row").hide(),h=!1),e.preventDefault()})}function i(){$(f).html("")}return RED.events.on("view:selection-changed",function(e){if(e.nodes){if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?o(RED.nodes.subflow(t.z)):o(t)}}else{var n=RED.nodes.subflow(RED.workspaces.active());n?o(n):i()}}),{init:function(){RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:f,enableOnEdit:!0})},show:function(){RED.sidebar.show("info")},refresh:o,clear:i,set:function(e){$(f).html(e)}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(e);var t=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),i=$("<div>").appendTo(e),a=$("<div>").appendTo(e),r=$("<div>").appendTo(e),s=!1,l={};function d(e,t,n){if(e=e.replace(/\./i,"-"),l[e])l[e].label!==n&&(l[e].list.parent().find(".config-node-label").text(n),l[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),i=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(i):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(i),$('<span class="config-node-filter-info"></span>').appendTo(i),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var a=i.find("i"),r={label:n,list:category,size:function(){return r.list.find("li:not(.config_node_none)").length},open:function(e){a.hasClass("expanded")||(a.addClass("expanded"),e?r.list.show():r.list.slideDown())},close:function(e){a.hasClass("expanded")&&(a.removeClass("expanded"),e?r.list.hide():r.list.slideUp())},isOpen:function(){return a.hasClass("expanded")}};i.on("click",function(e){r.isOpen()?r.close():r.open()}),l[e]=r}return l[e]}function c(e,t){var n=d(e.replace(/\./i,"-")),i=n.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),s){var o=t.length;0<(o-=(t=t.filter(function(e){return 0===e.users.length})).length)?i.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:o})).show():i.parent().find(".config-node-filter-info").hide()}else i.parent().find(".config-node-filter-info").hide();if(i.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(i),n.close(!0);else{var a="";t.forEach(function(t){var n="";if("function"==typeof t._def.label)try{n=t._def.label.call(t)}catch(e){console.log("Definition error: "+t._def.type+".label",e),n=t._def.type}else n=t._def.label;n=n||t.id,t.type!=a&&($('<li class="config_node_type">'+t.type+"</li>").appendTo(i),a=t.type);var e=$('<li class="palette_node config_node palette_node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(i);$('<div class="palette_label"></div>').text(n).appendTo(e);$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(t.users.length).appendTo(e);0===t.users.length&&e.addClass("config_node_unused"),e.on("click",function(e){RED.sidebar.info.refresh(t)}),e.on("dblclick",function(e){RED.editor.editConfig("",t.type,t.id)});var o=t.users.map(function(e){return e.id});e.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=o.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),e.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),n.open(!0)}}function n(){var t={global:!0};d("global",i),RED.nodes.eachWorkspace(function(e){t[e.id.replace(/\./g,"-")]=!0,d(e.id,a,e.label)}),RED.nodes.eachSubflow(function(e){t[e.id.replace(/\./g,"-")]=!0,d(e.id,r,e.name)}),$(".workspace-config-node-category").each(function(){var e=$(this).attr("id").substring("workspace-config-node-category-".length);t[e]||($(this).remove(),delete l[e])});var n=[],o={};for(var e in RED.nodes.eachConfig(function(e){e.z?(o[e.z.replace(/\./g,"-")]=o[e.z.replace(/\./g,"-")]||[],o[e.z.replace(/\./g,"-")].push(e)):e.z||n.push(e)}),t)t.hasOwnProperty(e)&&c(e,o[e]||[]);c("global",n)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,closeable:!0,visible:!1,onchange:function(){n()}}),RED.menu.setAction("menu-item-config-nodes",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){for(var t in e.preventDefault(),l)l.hasOwnProperty(t)&&l[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){for(var t in e.preventDefault(),l)l.hasOwnProperty(t)&&0<l[t].size()&&l[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),s&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),s=!s,n())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),s||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),s=!s,n())})},show:function(s){"boolean"==typeof s&&(s?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),n(),"string"==typeof s&&($("#workspace-config-node-filter-all").click(),s=s.replace(/\./g,"-"),setTimeout(function(){var e=$(".palette_node_id_"+s),t=e.position().top,n=e.height(),o=$(".sidebar-node-config"),i=o.height();i<t+n?o.animate({scrollTop:"-="+(i-(t+n)-30)},150):t<0&&o.animate({scrollTop:"+="+(t-10)},150);var a=21,r=function(){a%2==0?e.removeClass("node_highlighted"):e.addClass("node_highlighted"),0<=--a&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:n}}(),RED.palette.editor=function(){var d,c,u,v,f,i,p=!1,h=[],g=[],m={},b={},y={},t={},D="";function r(e,t){var n=Date.now()-e;n=n<300?300:0,setTimeout(function(){t()},n)}function w(e,t,o,i){o.show();var a=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){r(a,function(){o.hide(),i()})}).fail(function(e,t,n){r(a,function(){o.hide(),i(e)})})}function E(e){t.hasOwnProperty(e)||(t[e]=setTimeout(function(){delete t[e],n(e)},100))}function R(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),i=parseInt(t[3]);if(160<(299*n+587*o+114*i)/1e3)return"rgb("+(n=Math.floor(.8*n))+","+(o=Math.floor(.8*o))+","+(i=Math.floor(.8*i))+")"}return e}function n(e){if(y.hasOwnProperty(e)){var t=y[e].info,n=y[e].elements;if(n){var o=0,i=0;for(var a in y[e].totalUseCount=0,y[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(a)){var r=0,s=t.sets[a],l=n.sets[a];s.enabled&&(o+=s.types.length),i+=s.types.length;for(var d=0;d<t.sets[a].types.length;d++){var c=t.sets[a].types[d];r+=b[c]||0;var u=l.swatches[c];if(s.enabled){var p=RED.nodes.getType(c);p&&p.color?(u.css({background:p.color}),u.css({border:"1px solid "+R(u.css("backgroundColor"))})):u.css({background:"#eee",border:"1px dashed #999"})}else u.css({background:"#eee",border:"1px dashed #999"})}y[e].setUseCount[a]=r,y[e].totalUseCount+=r,0<r?(l.enableButton.html(RED._("palette.editor.inuse")),l.enableButton.addClass("disabled")):(l.enableButton.removeClass("disabled"),s.enabled?l.enableButton.html(RED._("palette.editor.disable")):l.enableButton.html(RED._("palette.editor.enable"))),l.setRow.toggleClass("palette-module-set-disabled",!s.enabled)}var f=o===i?i:o+" / "+i;n.setCount.html(RED._("palette.editor.nodeCount",{count:i,label:f})),0<y[e].totalUseCount?(n.enableButton.html(RED._("palette.editor.inuse")),n.enableButton.addClass("disabled"),n.removeButton.hide()):(n.enableButton.removeClass("disabled"),t.local&&n.removeButton.show(),0===o?n.enableButton.html(RED._("palette.editor.enableall")):n.enableButton.html(RED._("palette.editor.disableall")),n.container.toggleClass("disabled",0===o))}n.updateButton.hide()}else{y[e]={info:RED.nodes.registry.getModule(e)};var h=[e];for(var g in y[e].info.sets)y[e].info.sets.hasOwnProperty(g)&&(h.push(g),h=h.concat(y[e].info.sets[g].types));y[e].index=h.join(",").toLowerCase(),v.editableList("addItem",y[e])}}function k(){RED.keyboard.remove("*"),$("#main-container").removeClass("palette-expanded"),$("#header-shade").hide(),$("#editor-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),$("#palette-editor").find(".expanded").each(function(e,t){$(t).find(".palette-module-content").slideUp(),$(t).removeClass("expanded")}),c.searchBox("value",""),u.searchBox("value",""),RED.events.emit("palette-editor:close")}var a,s=[],_=C;function x(){if(0===h.length){h=[],m={},f.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];s=[],i=e.length,1<e.length&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),a=Date.now(),e.forEach(function(e,t){$.getJSON(e,{_:(new Date).getTime()},function(e){!function(e,t,n){if(s.push(n),n.modules&&(n.modules.forEach(function(e){(m[e.id]=e).index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),h=h.concat(n.modules)),u.searchBox("count",h.length),1<i&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+s.length+"/"+i),s.length===i){var o=250-(Date.now()-a);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(o,0))}}(0,0,e),function(){for(var e in y)y.hasOwnProperty(e)&&n(e)}()})})}}function T(){f.editableList("empty"),g.sort(_);for(var e=0;e<Math.min(10,g.length);e++)f.editableList("addItem",g[e]);0===g.length&&f.editableList("addItem",{}),10<g.length&&f.editableList("addItem",{start:10,more:g.length-10})}function C(e,t){return e.info.id.localeCompare(t.info.id)}function O(e,t){return-1*(e.info.timestamp-t.info.timestamp)}return{init:function(){if(!1!==RED.settings.theme("palette.editable")){RED.events.on("editor:open",function(){p=!0}),RED.events.on("editor:close",function(){p=!1}),RED.events.on("search:open",function(){p=!0}),RED.events.on("search:close",function(){p=!1}),RED.keyboard.add("*",80,{shift:!0,ctrl:!0},function(){RED.palette.editor.show(),d3.event.preventDefault()}),d=RED.tabs.create({id:"palette-editor-tabs",onchange:function(e){$("#palette-editor .palette-editor-tab").hide(),e.content.show(),c&&c.searchBox("value",""),u&&u.searchBox("value",""),"install"===e.id?u&&u.focus():c&&c.focus()},minimumActiveTabWidth:110}),$("#editor-shade").click(function(){$("#main-container").hasClass("palette-expanded")&&k()}),$("#palette-editor-close").on("click",function(e){k()});var e=$("<div>",{class:"palette-editor-tab"}).appendTo("#palette-editor");d.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:e});var t=$("<div>",{class:"palette-search"}).appendTo(e);c=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(t).searchBox({delay:200,change:function(){!function(e){D=e.toLowerCase();var t=v.editableList("filter"),n=v.editableList("length");""===e?c.searchBox("count"):c.searchBox("count",t+" / "+n)}($(this).val())}}),v=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===D||""===D||-1<e.index.indexOf(D)},addItem:function(t,e,r){var s=r.info;if(s){var n=$("<div>",{class:"palette-module-header"}).appendTo(t),o=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n);$("<span>").html(s.name).appendTo(o);var i=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n);$("<span>").html(s.version).appendTo(i);var a=$("<div>",{class:"palette-module-meta"}).appendTo(n),l=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(a),d=$("<span>").appendTo(l),c=$("<div>",{class:"palette-module-button-group"}).appendTo(a),u=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.update")).appendTo(c);u.click(function(e){e.preventDefault()});var p=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.remove")).appendTo(c);p.click(function(e){var t,o;e.preventDefault(),g.show(),t=s.name,o=function(e){console.log(e)},$.ajax({url:"nodes/"+t,type:"DELETE"}).done(function(e,t,n){o()}).fail(function(e,t,n){o(e)})}),s.local||p.hide();var f=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.disableall")).appendTo(c),h=$("<div>",{class:"palette-module-content"}).appendTo(t),g=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(t);r.elements={updateButton:u,removeButton:p,enableButton:f,setCount:d,container:t,shade:g,sets:{}},l.click(function(e){e.preventDefault(),t.hasClass("expanded")?(t.removeClass("expanded"),h.slideUp()):(t.addClass("expanded"),h.slideDown())});var v=Object.keys(s.sets);v.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),v.forEach(function(n){var o=s.sets[n],i=$("<div>",{class:"palette-module-set"}).appendTo(h),e=$("<div>",{class:"palette-module-set-button-group"}).appendTo(i),a={};o.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(i);a[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).html(e).appendTo(t)});var t=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(e);t.click(function(e){if(e.preventDefault(),0===r.setUseCount[n]){var t=RED.nodes.registry.getNodeSet(o.id);g.show(),w(o.id,!t.enabled,g,function(e){console.log(e)})}}),r.elements.sets[o.name]={setRow:i,enableButton:t,swatches:a}}),f.click(function(e){e.preventDefault(),0===r.totalUseCount&&w(s.name,t.hasClass("disabled"),g,function(e){console.log(e)})}),E(s.name)}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(t)}});var n=$("<div>",{class:"palette-editor-tab hide"}).appendTo("#palette-editor");d.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:n});var o=$("<div>",{class:"palette-editor-toolbar"}).appendTo(n),i=$("<div>",{class:"palette-search"}).appendTo(n);u=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(i).searchBox({delay:300,change:function(){var t=$(this).val().toLowerCase();0<t.length?(g=h.filter(function(e){return-1<e.index.indexOf(t)}).map(function(e){return{info:e}}),T(),u.searchBox("count",g.length+" / "+h.length)):(u.searchBox("count",h.length),f.editableList("empty"))}}),$("<span>").html(RED._("palette.editor.sort")+" ").appendTo(o);var a=$('<span class="button-group"></span> ').appendTo(o),r=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(a),s=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(a);r.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),s.removeClass("selected"),_=C,T())}),s.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),r.removeClass("selected"),_=O,T())});var l=$("<span>").appendTo(o);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(l).click(function(e){e.preventDefault(),h=[],m={},x()}),f=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(n).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(n.more){e.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(e);$('<a href="#"></a>').html(RED._("palette.editor.more",{count:n.more})).appendTo(o).click(function(e){e.preventDefault(),f.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)f.editableList("addItem",g[t]);10<n.more&&f.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var a=n.info,i=$("<div>",{class:"palette-module-header"}).appendTo(e),r=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>",{class:"palette-module-name"}).html(a.name||a.id).appendTo(r),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",a.url).appendTo(r);var s=$('<div class="palette-module-meta"></div>').appendTo(i);$("<div>",{class:"palette-module-description"}).html(a.description).appendTo(s);var l=$('<div class="palette-module-meta"></div>').appendTo(i);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+a.version+"</span>").appendTo(l),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var i=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:i}):RED._("palette.editor.times.year"+(1<i?"s":"")+"MonthsV",{y:i,count:o})}(a.updated_at)+"</span>").appendTo(l);var d=$("<div>",{class:"palette-module-meta"}).appendTo(i),c=$("<div>",{class:"palette-module-button-group"}).appendTo(d),u=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e),p=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.install")).appendTo(c);p.click(function(e){var t,o,i;e.preventDefault(),$(this).hasClass("disabled")||(t=a.id,i=function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:a.id,message:e.responseJSON.message}))},(o=u).show(),$.ajax({url:"nodes",type:"POST",data:JSON.stringify({module:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){o.hide(),i()}).fail(function(e,t,n){o.hide(),i(e)}))}),y.hasOwnProperty(a.id)&&(p.addClass("disabled"),p.html(RED._("palette.editor.installed"))),n.elements={installButton:p}}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(n),RED.events.on("registry:node-set-enabled",function(e){E(e.module)}),RED.events.on("registry:node-set-disabled",function(e){E(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||E(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||E(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){E(e.module);for(var t=0;t<g.length;t++)if(g[t].info.id===e.module){g[t].elements.installButton.hide();break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=y[e.module];if(t){v.editableList("removeItem",t),delete y[e.module];for(var n=0;n<g.length;n++)if(g[n].info.id===e.module){g[n].elements.installButton.show();break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(b[e.type]=(b[e.type]||0)+1,1===b[e.type]&&E(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){b.hasOwnProperty(e.type)&&(b[e.type]--,0===b[e.type]&&(delete b[e.type],E(RED.nodes.registry.getNodeSetForType(e.type).module)))})}},show:function(){!1!==RED.settings.theme("palette.editable")&&(p||(x(),$("#header-shade").show(),$("#editor-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),d.activateTab("nodes"),$("#main-container").addClass("palette-expanded"),setTimeout(function(){d.resize(),c.focus()},250),RED.events.emit("palette-editor:open"),RED.keyboard.add("*",27,function(){k(),d3.event.preventDefault()})))}}}(),RED.editor=function(){var r=[],a=null,n={};function b(e){var t,n,o,i=e.valid,a=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))n=(t=RED.nodes.subflow(e.type.substring(8))).valid,o=t.changed,void 0===n&&(n=b(t),o=t.changed),e.valid=n,e.changed=e.changed||o;else if(e._def)e.valid=c(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&c(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var r=RED.nodes.filterNodes({z:e.id}),s=0;s<r.length;s++)n=r[s].valid,o=r[s].changed,void 0===n&&(n=b(r[s]),o=r[s].changed),e.valid=e.valid&&n,e.changed=e.changed||o;var l=RED.nodes.filterNodes({type:"subflow:"+e.id}),d={};for(s=0;s<l.length;s++)l[s].valid=e.valid,l[s].changed=l[s].changed||e.changed,l[s].dirty=!0,d[l[s].z]=!0;Object.keys(d).forEach(function(e){var t=RED.nodes.subflow(e);t&&b(t)})}return i===e.valid&&a===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&b(t)),e.valid}function c(e,t,n){var o=!0;for(var i in t)t.hasOwnProperty(i)&&(s(e,t,i,n[i])||(o=!1));return o}function s(t,e,n,o){var i=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in e[n]&&e[n].required&&(i=""!==o),i&&"validate"in e[n])try{i=e[n].validate.call(t,o)}catch(e){console.log("Validation error:",t.type,t.id,"property: "+n,"value:",o,e)}if(i&&e[n].type&&RED.nodes.getType(e[n].type)&&!("validate"in e[n]))if(o&&"_ADD_"!=o){var a=RED.nodes.node(o);i=null!==a&&(null==a.valid||a.valid)}else i=e[n].hasOwnProperty("required")&&!e[n].required;return i}function l(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&o(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&o(e,e._def.credentials,n,t)}function o(e,t,n,o){var i=$("#"+o+"-"+n);if(0<i.length){var a=i.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===i[0].nodeName&&(a=i.text()),s(e,t,n,a)?i.removeClass("input-error"):i.addClass("input-error")}}function m(t){t.resize=!0,t.dirty=!0;var n=[];if(t.ports)if(t.outputs<t.ports.length){for(;t.outputs<t.ports.length;)t.ports.pop();RED.nodes.eachLink(function(e){e.source===t&&e.sourcePort>=t.outputs&&n.push(e)})}else if(t.outputs>t.ports.length)for(;t.outputs>t.ports.length;)t.ports.push(t.ports.length);0===t.inputs&&n.concat(RED.nodes.filterLinks({target:t}));for(var e=0;e<n.length;e++)RED.nodes.removeLink(n[e]);return n}function d(e,t,n,o){var i=$("#"+o+"-"+t);if(0!==i.length){var a,r=i.width(),s=i.attr("style");r=null!==(a=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(s))?a[1]:"70%";var l=$("<div></div>").css({display:"inline-block",position:"relative"}),d=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(l),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(d);l.width(r).height(i.height()),0===l.width()&&l.width("70%"),i.replaceWith(l),c.attr("style","width:100%"),E(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(l),$("#"+o+"-lookup-"+t).click(function(e){g(t,n,c.find(":selected").val(),o),e.preventDefault()});var u="",p=RED.nodes.node(e[t]),f=RED.nodes.getType(n);if(p&&f.label)if("function"==typeof f.label)try{u=f.label.call(p)}catch(e){console.log("Definition error: "+f.type+".label",e),u=f.type}else u=f.label;i.val(u)}}function u(e,t,n,o){var i=$("#"+o+"-"+t);i.val(e[t]),i.attr("type","hidden");var a=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});i.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.click(function(e){g(t,n,i.val()||"_ADD_",o),e.preventDefault()})}function p(e,t,n,o){var i=$("#"+n+"-"+t);if(0!==i.length)if("checkbox"===i.attr("type"))i.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===i[0].nodeName?(i.html(RED.text.format.getHtml(a,o[t].format,{},!1,"en")),RED.text.format.attach(i[0],o[t].format,{},!1,"en")):(i.val(a),"INPUT"!==i[0].nodeName&&"TEXTAREA"!==i[0].nodeName||RED.text.bidi.prepareInput(i))}}function f(n,e,t,o){var i=$("#"+o+"-"+t);void 0!==e&&"format"in e[t]&&""!==e[t].format&&"DIV"===i[0].nodeName?$("#"+o+"-"+t).on("change keyup",function(e,t){t||l(n,o)}):$("#"+o+"-"+t).change(function(e,t){t||l(n,o)})}function h(e,t,n,o){var i;for(i in t)t.hasOwnProperty(i)&&("password"==t[i].type?n[i]?$("#"+o+"-"+i).val(n[i]):n["has_"+i]?$("#"+o+"-"+i).val("__PWRD__"):$("#"+o+"-"+i).val(""):p(n,i,o,t),f(e,t,i,o))}function y(e,t,n){var o=!1;for(var i in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(i)){var a=$("#"+n+"-"+i).val();if("password"==t[i].type){if(e.credentials["has_"+i]=""!==a,"__PWRD__"==a)continue;o=!0}(e.credentials[i]=a)!=e.credentials._[i]&&(o=!0)}return o}function D(t,n,o){for(var e in n.defaults)if(n.defaults.hasOwnProperty(e)){if(n.defaults[e].type){var i=RED.nodes.getType(n.defaults[e].type);i?i.exclusive?u(t,e,n.defaults[e].type,o):d(t,e,n.defaults[e].type,o):(console.log("Unknown type:",n.defaults[e].type),p(t,e,o,n.defaults))}else p(t,e,o,n.defaults);f(t,n.defaults,e,o)}var a,r,s=function(){if(n.oneditprepare)try{n.oneditprepare.call(t)}catch(e){console.log("oneditprepare",t.id,t.type,e.toString())}for(var e in n.defaults)n.defaults.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);if(n.credentials)for(e in n.credentials)n.credentials.hasOwnProperty(e)&&$("#"+o+"-"+e).trigger("change",[!0]);l(t,o)};n.credentials?t.credentials?(h(t,n.credentials,t.credentials,o),s()):$.getJSON((a=t.type,r=t.id,"credentials/"+a.replace(/\s+/g,"-")+"/"+r),function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),h(t,n.credentials,t.credentials,o),s()}):s()}function w(){for(var e='<ul class="editor-tray-breadcrumbs">',t=0;t<r.length;t++){var n=r[t],o=n.type;if("subflow"===n.type)o=RED._("subflow.editSubflow",{name:n.name});else if(0===n.type.indexOf("subflow:")){var i=RED.nodes.subflow(n.type.substring(8));o=RED._("subflow.editSubflow",{name:i.name})}else{if(void 0!==n._def.paletteLabel)try{o=("function"==typeof n._def.paletteLabel?n._def.paletteLabel.call(n._def):n._def.paletteLabel)||""}catch(e){console.log("Definition error: "+n.type+".paletteLabel",e)}t===r.length-1&&(o=RED.nodes.node(n.id)?RED._("editor.editNode",{type:o}):RED._("editor.addNewConfig",{type:o}))}e+="<li>"+o+"</li>"}return e+="</ul>"}function g(f,h,e,g){var s,v="_ADD_"==e,l=RED.nodes.getType(h),m=RED.nodes.node(e);s="node-red"===l.set.module?"node-red":l.set.id;var t="",n=RED.nodes.subflow(RED.workspaces.active());if(n&&(t=n.id),null==m){for(var o in m={id:RED.nodes.id(),_def:l,type:h,z:t,users:[]},l.defaults)l.defaults[o].value&&(m[o]=JSON.parse(JSON.stringify(l.defaults[o].value)));m._=l._}r.push(m),RED.view.state(RED.state.EDITING);var i={title:w(),resize:function(){if(m&&m._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{m._def.oneditresize.call(m,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",a.id,a.type,e.toString())}}},open:function(e){e.find(".editor-tray-header");var t=e.find(".editor-tray-body"),n=e.find(".editor-tray-footer");!1!==l.hasUsers&&n.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),n.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var o=$('<form id="node-config-dialog-edit-form" class="form-horizontal"></form>').appendTo(t);o.html($("script[data-template-name='"+h+"']").html()),o.find("[data-i18n]").each(function(){var e=$(this).attr("data-i18n");if(-1===e.indexOf(":")){var t="";if(0===e.indexOf("[")){var n=e.split("]");t=n[0]+"]",e=n[1]}$(this).attr("data-i18n",t+s+":"+e)}}),$('<input type="text" style="display: none;" />').prependTo(o),D(m,l,"node-config-input"),m._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var i={};m.users.forEach(function(e){i[e.z]=!0});var a=Object.keys(i).length,r=$("#node-config-dialog-scope").empty();r.off("change"),r.append('<option value=""'+(m.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),r.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(e){var t=e.label;i[e.id]&&(t="* "+t),r.append('<option value="'+e.id+'"'+(e.id==m.z?" selected":"")+">"+t+"</option>")}),r.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(e){var t=e.name;i[e.id]&&(t="* "+t),r.append('<option value="'+e.id+'"'+(e.id==m.z?" selected":"")+">"+t+"</option>")}),0<a&&r.on("change",function(){var e=$(this).val();""===e?$("#node-config-dialog-scope-warning").hide():!i[e]||1<a?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),r.i18n(),o.i18n(),!1!==l.hasUsers&&$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:m.users.length})).parent().show()},close:function(){RED.workspaces.refresh(),r.pop()},show:function(){m&&RED.sidebar.info.refresh(m)}};i.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var t=h,n=m.id,e=RED.nodes.getType(t);if(e.oneditcancel&&e.oneditcancel){var o=RED.nodes.node(n);if(o)try{e.oneditcancel.call(o,!1)}catch(e){console.log("oneditcancel",o.id,o.type,e.toString())}else try{e.oneditcancel.call({id:n},!0)}catch(e){console.log("oneditcancel",n,t,e.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:v?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,n=f,o=(m.id,h),i=v,a=RED.nodes.getType(o),r=$("#node-config-dialog-scope").val();if(a.oneditsave)try{a.oneditsave.call(m)}catch(e){console.log("oneditsave",m.id,m.type,e.toString())}for(e in a.defaults){var s;if(a.defaults.hasOwnProperty(e))if(null!=(s="checkbox"===(t=$("#node-config-input-"+e)).attr("type")?t.prop("checked"):"format"in a.defaults[e]&&""!==a.defaults[e].format&&"DIV"===t[0].nodeName?t.text():t.val())&&s!==m[e]){if(m._def.defaults[e].type){"_ADD_"==s&&(s="");var l=RED.nodes.node(m[e]);if(l){var d=l.users;d.splice(d.indexOf(m),1)}(l=RED.nodes.node(s))&&l.users.push(m)}m[e]=s}}m.label=a.label,(m.z=r)&&(m.users=m.users.filter(function(e){var t=!0;for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&e._def.defaults[n].type===m.type&&e[n]===m.id&&e.z!==r&&(t=!1,e[n]=null,e.dirty=!0,e.changed=!0,b(e));return t})),i&&RED.nodes.add(m),a.credentials&&y(m,a.credentials,"node-config-input"),b(m);var c={};c[m.id]=!0;for(var u=m.users.slice();0<u.length;){var p=u.pop();c[p.id]||(c[p.id]=!0,p.users&&(u=u.concat(p.users)),b(p))}RED.nodes.dirty(!0),RED.view.redraw(!0),i||RED.events.emit("editor:save",m),RED.tray.close(function(){E(n,o,m.id,g)})}}],v||i.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=f,t=m.id,n=h,o=RED.nodes.getType(n);try{o.ondelete&&(console.log("Deprecated API warning: config node type ",n," has an ondelete function - should be oneditdelete"),o.ondelete.call(m)),o.oneditdelete&&o.oneditdelete.call(m)}catch(e){console.log("oneditdelete",m.id,m.type,e.toString())}for(var i={t:"delete",nodes:[m],changes:{},dirty:RED.nodes.dirty()},a=0;a<m.users.length;a++){var r=m.users[a];for(var s in i.changes[r.id]={changed:r.changed,valid:r.valid},r._def.defaults)r._def.defaults.hasOwnProperty(s)&&r[s]==t&&(i.changes[r.id][s]=t,r[s]="",r.changed=!0,r.dirty=!0);b(r)}RED.nodes.remove(t),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(i),RED.tray.close(function(){E(e,n,"",g)})}}),RED.tray.show(i)}function v(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function E(e,n,t,o){if(o){var i=$("#"+o+"-edit-"+e);if(i.length)t?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(t);else{var a=$("#"+o+"-"+e),r=RED.nodes.getType(n);a.children().remove();var s=RED.nodes.workspace(RED.workspaces.active());s||(s=RED.nodes.subflow(RED.workspaces.active()));var l=[];RED.nodes.eachConfig(function(e){if(e.type==n&&(!e.z||e.z===s.id)){var t="";if("function"==typeof r.label)try{t=r.label.call(e)}catch(e){console.log("Definition error: "+r.type+".label",e),t=r.type}else t=r.label;e.__label__=t,l.push(e)}});var d=v;"function"==typeof r.sort&&(d=r.sort);try{l.sort(d)}catch(e){console.log("Definition error: "+r.type+".sort",e)}l.forEach(function(e){a.append('<option value="'+e.id+'"'+(t==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),a.append('<option value="_ADD_"'+(""===t?" selected":"")+">"+RED._("editor.addNewType",{type:n})+"</option>"),window.setTimeout(function(){a.change()},50)}}}return{init:function(){RED.tray.init(),$(window).on("keydown",function(e){e.keyCode===$.ui.keyCode.ESCAPE&&(e.metaKey||e.ctrlKey)?($("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()):e.keyCode===$.ui.keyCode.ENTER&&(e.metaKey||e.ctrlKey)&&($("#node-dialog-ok").click(),$("#node-config-dialog-ok").click())})},edit:function(o){var v=o;r.push(o),RED.view.state(RED.state.EDITING);var i=o.type;"subflow:"==o.type.substring(0,8)&&(i="subflow");var e={title:w(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(v._def){if(v._def.oneditcancel)try{v._def.oneditcancel.call(v)}catch(e){console.log("oneditcancel",v.id,v.type,e.toString())}for(var e in v._def.defaults)if(v._def.defaults.hasOwnProperty(e)){var t=v._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||v[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t={},n=!1,o=RED.nodes.dirty();if(v._def.oneditsave){var i={};for(e in v._def.defaults)v._def.defaults.hasOwnProperty(e)&&("string"==typeof v[e]||"number"==typeof v[e]?i[e]=v[e]:i[e]=$.extend(!0,{},{v:v[e]}).v);try{!0===v._def.oneditsave.call(v)&&(n=!0)}catch(e){console.log("oneditsave",v.id,v.type,e.toString())}for(e in v._def.defaults)v._def.defaults.hasOwnProperty(e)&&(null===i[e]||"string"==typeof i[e]||"number"==typeof i[e]?i[e]!==v[e]&&(t[e]=i[e],n=!0):JSON.stringify(i[e])!==JSON.stringify(v[e])&&(t[e]=i[e],n=!0))}if(v._def.defaults)for(e in v._def.defaults)if(v._def.defaults.hasOwnProperty(e)){var a,r=$("#node-input-"+e);if(null!=(a="checkbox"===r.attr("type")?r.prop("checked"):"format"in v._def.defaults[e]&&""!==v._def.defaults[e].format&&"DIV"===r[0].nodeName?r.text():r.val())){if("outputs"===e&&(""===a.trim()||isNaN(a)))continue;if(v[e]!=a){if(v._def.defaults[e].type){"_ADD_"==a&&(a="");var s=RED.nodes.node(v[e]);if(s){var l=s.users;l.splice(l.indexOf(v),1)}(s=RED.nodes.node(a))&&s.users.push(v)}t[e]=v[e],v[e]=a,n=!0}}}if(v._def.credentials){var d=v._def.credentials,c=y(v,d,"node-input");n=n||c}var u=m(v);if(n){var p=v.changed;v.changed=!0,RED.nodes.dirty(!0);var f=RED.nodes.subflow(RED.workspaces.active()),h=null;f&&(h=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(h.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,m(e))}));var g={t:"edit",node:v,changes:t,links:u,dirty:o,changed:p};h&&(g.subflow={instances:h}),RED.history.push(g)}v.dirty=!0,b(v),RED.events.emit("editor:save",v),RED.tray.close()}}],resize:function(e){if(n[i]=e.width,v&&v._def.oneditresize){var t=$("#dialog-form");try{v._def.oneditresize.call(v,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",v.id,v.type,e.toString())}}},open:function(e){v&&RED.sidebar.info.refresh(v);var a,t=e.find(".editor-tray-body"),n=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);n.html($("script[data-template-name='"+i+"']").html()),a="node-red"===o._def.set.module?"node-red":o._def.set.id,n.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var o="";if(0===n.indexOf("[")){var i=n.split("]");o=i[0]+"]",n=i[1]}e[t]=o+a+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="text" style="display: none;" />').prependTo(n),D(o,o._def,"node-input"),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),v&&RED.sidebar.info.refresh(v),RED.workspaces.refresh(),RED.view.redraw(!0),r.pop()},show:function(){v&&RED.sidebar.info.refresh(v)}};if(n.hasOwnProperty(i)&&(e.width=n[i]),"subflow"===i){var t=v.type.substring(8);e.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(t),$("#node-dialog-ok").click()}})}RED.tray.show(e)},editConfig:g,editSubflow:function(a){var l,d=a;r.push(a),RED.view.state(RED.state.EDITING);var e={title:w(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,n=RED.nodes.dirty(),o=$("#subflow-input-name").val();o!=d.name&&(e.name=d.name,d.name=o,t=!0);var i=l.getValue();if(i!=d.info&&(e.info=d.info,d.info=i,t=!0),RED.palette.refresh(),t){var a=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+d.id&&(a.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,m(e))});var r=d.changed;d.changed=!0,RED.nodes.dirty(!0);var s={t:"edit",node:d,changes:e,dirty:n,changed:r,subflow:{instances:a}};RED.history.push(s)}d.dirty=!0,RED.tray.close()}}],resize:function(){for(var e=$("#dialog-form>div:not(.node-text-editor-row)"),t=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<e.size();n++)t-=$(e[n]).outerHeight(!0);t-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",t+"px"),l.resize()},open:function(e){d&&RED.sidebar.info.refresh(d);var t=e.find(".editor-tray-body"),n=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);n.html($("script[data-template-name='subflow-template']").html()),n.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var o="";if(0===n.indexOf("[")){var i=n.split("]");o=i[0]+"]",n=i[1]}e[t]=o+"node-red:"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="text" style="display: none;" />').prependTo(n),n.submit(function(e){e.preventDefault()}),l=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(a.name),RED.text.bidi.prepareInput($("#subflow-input-name")),l.getSession().setValue(a.info||"",-1);var o=0,i="subflow:"+d.id;RED.nodes.eachNode(function(e){e.type===i&&o++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:o})).show(),n.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(d),RED.workspaces.refresh(),r.pop(),d=null},show:function(){}};RED.tray.show(e)},validateNode:b,updateNodeProperties:m,createEditor:function(e){var t=ace.edit(e.id);t.setTheme("ace/theme/tomorrow");var n=t.getSession();return e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),t.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6}])},100),t}}}(),RED.tray=function(){var f=[],h=$("#editor-stack"),g=!1;function n(e){var n=$('<div class="editor-tray"></div>'),t=$('<div class="editor-tray-header"></div>').appendTo(n),o=$('<div class="editor-tray-body-wrapper"></div>').appendTo(n),i=$('<div class="editor-tray-body"></div>').appendTo(o),a=$('<div class="editor-tray-footer"></div>').appendTo(n),r=$('<div class="editor-tray-resize-handle"></div>').appendTo(n);e.title&&$('<div class="editor-tray-titlebar">'+e.title+"</div>").appendTo(t);var s,l=$('<div class="editor-tray-toolbar"></div>').appendTo(t);if(e.buttons)for(var d=0;d<e.buttons.length;d++){var c=e.buttons[d],u=$("<button>").button().appendTo(l);c.id&&u.attr("id",c.id),c.text&&u.html(c.text),c.click&&u.click(function(t){return function(e){$(this).hasClass("disabled")||t(e)}}(c.click)),c.class&&(u.addClass(c.class),"primary"===c.class&&(s=c))}n.appendTo(h);var p={tray:n,header:t,body:i,footer:a,options:e,primaryButton:s};f.push(p),n.draggable({handle:r,axis:"x",start:function(e,t){n.width("auto")},drag:function(e,t){var n=h.position().left+t.position.left;n<7?t.position.left+=7-n:t.position.left>-p.preferredWidth-1&&(t.position.left=-Math.min(h.position().left-7,p.preferredWidth-1)),p.options.resize&&setTimeout(function(){p.options.resize({width:-t.position.left})},0),p.width=-t.position.left},stop:function(e,t){n.width(-t.position.left),n.css({left:""}),p.options.resize&&p.options.resize({width:-t.position.left}),p.width=-t.position.left}}),e.open&&e.open(n),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),p.preferredWidth=Math.max(n.width(),500),i.css({minWidth:p.preferredWidth-40}),e.width?(e.width>$("#editor-stack").position().left-8&&(e.width=$("#editor-stack").position().left-8),n.width(e.width)):n.width(p.preferredWidth),p.width=n.width(),p.width>$("#editor-stack").position().left-8&&(p.width=Math.max(0,$("#editor-stack").position().left-8),n.width(p.width)),n.css({right:-(n.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),v(),g=!0,setTimeout(function(){setTimeout(function(){e.width||n.width(Math.min(p.preferredWidth,$("#editor-stack").position().left-8)),e.resize&&e.resize({width:n.width()}),e.show&&e.show(),setTimeout(function(){g=!1},200)},150),n.css({right:0})},0)}function v(){if(0<f.length){var e=f[f.length-1],t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(t-40),e.width>$("#editor-stack").position().left-8?(e.width=$("#editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width)),e.options.resize&&e.options.resize({width:e.width})}}return{init:function(){$(window).resize(v),RED.events.on("sidebar:resize",v),$("#editor-shade").click(function(){if(!g){var e=f[f.length-1];e&&e.primaryButton&&e.primaryButton.click()}})},show:function(e){if(0<f.length){var t=f[f.length-1];t.tray.css({right:-(t.tray.width()+10)+"px"}),setTimeout(function(){t.tray.detach(),n(e)},250)}else RED.events.emit("editor:open"),n(e)},close:function(t){if(0<f.length){var n=f.pop();n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){if(n.options.close&&n.options.close(),n.tray.remove(),0<f.length){var e=f[f.length-1];e.tray.appendTo("#editor-stack"),setTimeout(function(){v(),e.tray.css({right:0}),e.options.show&&e.options.show()},0)}t&&t(),0===f.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var e,t,n,o;function i(){var t=$("#clipboard-import"),n=t.val();n=n.substring(n.indexOf("["),n.lastIndexOf("]")+1);try{JSON.parse(n),t.removeClass("input-error"),t.val(n),$("#clipboard-dialog-ok").button("enable")}catch(e){""!==n&&t.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function a(){t.empty(),t.append($(o)),t.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(i),$("#clipboard-import").on("paste",function(){setTimeout(i,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("open")}function r(){t.empty(),t.append($(n)),t.i18n(),$("#export-format-group > a").click(function(e){if(e.preventDefault(),!$(this).hasClass("disabled")&&!$(this).hasClass("selected")){$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(0<t.length){var n=JSON.parse(t);t="export-format-full"===$(this).attr("id")?JSON.stringify(n,null,4):JSON.stringify(n),$("#clipboard-export").val(t)}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),!$(this).hasClass("disabled")&&!$(this).hasClass("selected")){$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),n="",o=null;if("export-range-selected"===t){var i=RED.view.selection();o=RED.nodes.createExportableNodeSet(i.nodes)}else if("export-range-flow"===t){var a=RED.workspaces.active();o=RED.nodes.filterNodes({z:a});var r=RED.nodes.workspace(a)||RED.nodes.subflow(a);o.unshift(r),o=RED.nodes.createExportableNodeSet(o)}else"export-range-full"===t&&(o=RED.nodes.createCompleteNodeSet(!1));null!==o&&(n=RED.settings.flowFilePretty?JSON.stringify(o,null,4):JSON.stringify(o)),0<n.length?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(n)}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),RED.settings.flowFilePretty?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),setTimeout(function(){$("#clipboard-export").focus(),document.queryCommandEnabled("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())},0)}function s(){$("#dropTarget").hide(),RED.keyboard.remove(27)}return{init:function(){e=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',o='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.keyboard.add("workspace",69,{ctrl:!0},function(){r(),d3.event.preventDefault()}),RED.keyboard.add("workspace",73,{ctrl:!0},function(){a(),d3.event.preventDefault()}),$("#chart").on("dragenter",function(e){-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&($("#dropTarget").css({display:"table"}),RED.keyboard.add("*",27,s))}),$("#dropTarget").on("dragover",function(e){-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&e.preventDefault()}).on("dragleave",function(e){s()}).on("drop",function(e){var t=e.originalEvent.dataTransfer.getData("text/plain");s(),t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t),e.preventDefault()})},import:a,export:r}}(),RED.library=function(){var t;function e(){$.getJSON("library/flows",function(e){var t,s=function(e,t){var n,o,i,a=document.createElement("ul");if(""===t&&(a.id="menu-item-import-library-submenu"),a.className="dropdown-menu",e.d)for(n in e.d)if(e.d.hasOwnProperty(n)){(o=document.createElement("li")).className="dropdown-submenu pull-left",(i=document.createElement("a")).href="#";var r=n.replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");i.innerHTML=r,o.appendChild(i),o.appendChild(s(e.d[n],t+(""!==t?"/":"")+n)),a.appendChild(o)}if(e.f)for(n in e.f)e.f.hasOwnProperty(n)&&(o=document.createElement("li"),(i=document.createElement("a")).href="#",i.innerHTML=e.f[n],i.flowName=t+(""!==t?"/":"")+e.f[n],i.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},o.appendChild(i),a.appendChild(o));return a};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var n=s(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(s(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(n)})}return{init:function(){RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),!1!==RED.settings.theme("menu.menu-item-import-library")&&e(),(t=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(l){var r=null,s=null;function d(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function c(i,e){for(var t,n=document.createElement("ul"),o=0;o<e.length;o++){var a=e[o];"string"==typeof a?((t=d()).onclick=function(){var o=a;return function(e){var t=$('<li class="active"><span class="divider">/</span> <a href="#">'+o+"</a></li>");$("a",t).click(function(e){$(this).parent().nextAll().remove(),$.getJSON("library/"+l.url+i+o,function(e){$("#node-select-library").children().first().replaceWith(c(i+o+"/",e))}),e.stopPropagation()});var n=$("#node-dialog-library-breadcrumbs");$(".active",n).removeClass("active"),n.append(t),$.getJSON("library/"+l.url+i+o,function(e){$("#node-select-library").children().first().replaceWith(c(i+o+"/",e))})}}(),t.innerHTML='<i class="fa fa-folder"></i> '+a+"</i>"):((t=d()).innerHTML=a.name,t.onclick=function(){var t=a;return function(e){$(".list-selected",n).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+l.url+i+t.fn,function(e){r=t,s.setValue(e,-1)})}}()),n.appendChild(t)}return n}function e(e){var t=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");""===t&&(t=RED._("library.unnamedType",{type:l.type}));var n=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),o=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==n&&/.+\.js$/.test(n)){for(var i=o+(""===o?"":"/")+n,a={},r=0;r<l.fields.length;r++){var s=l.fields[r];"name"==s?a.name=t:a[s]=$("#node-input-"+s).val()}a.text=l.editor.getValue(),$.ajax({url:"library/"+l.url+"/"+i,type:"POST",data:JSON.stringify(a),contentType:"application/json; charset=utf-8"}).done(function(e,t,n){RED.notify(RED._("library.savedType",{type:l.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}l.editor.setText&&(l.editor.setValue=function(e,t){l.editor.setText.call(l.editor,e)}),l.editor.getText&&(l.editor.getValue=l.editor.getText),$("#node-input-name").css("width","60%").after('<div class="btn-group" style="margin-left: 5px;"><a id="node-input-'+l.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+l.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+l.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+l.type+"-menu-open-library").click(function(e){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),s.setValue("",-1),$.getJSON("library/"+l.url,function(t){$("#node-select-library").append(c("/",t)),$("#node-dialog-library-breadcrumbs a").click(function(e){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(c("/",t)),e.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),e.preventDefault()}),$("#node-input-"+l.type+"-menu-save-library").click(function(e){var t=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var n=t.replace(/[^\w-]/g,"-");""===n&&(n="unnamed-"+l.type),$("#node-dialog-library-save-filename").attr("value",n+".js"),$("#node-dialog-library-save").dialog("open"),e.preventDefault()}),(s=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),l.mode&&s.getSession().setMode(l.mode),s.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),s.renderer.$cursorLayer.element.style.opacity=0,s.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:l.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(r){for(var e=0;e<l.fields.length;e++){var t=l.fields[e];$("#node-input-"+t).val(r[t])}l.editor.setValue(s.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]})},loadFlowLibrary:e,export:function(){var e=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(e)),t.dialog("open")}}}(),RED.notify=function(){var u=[],p=0;return function(e,t,n,o){if(4<u.length)for(var i=u.length,a=0;4<i&&a<u.length;a+=1){var r=u[a];r.fixed||(window.clearTimeout(r.timeoutid),r.close(),i-=1)}var s,l,d,c=document.createElement("div");return c.id="red-notification-"+p,c.className="notification",c.fixed=n,t&&(c.className="notification notification-"+t),c.style.display="none",c.innerHTML=e,$("#notifications").append(c),$(c).slideDown(300),c.close=(s=c,function(){u.splice(u.indexOf(s),1),$(s).slideUp(300,function(){s.parentNode.removeChild(s)})}),c.update=(l=c,function(e){l.innerHTML=e}),n||($(c).click((d=c,function(){d.close(),window.clearTimeout(d.timeoutid)})),c.timeoutid=window.setTimeout(c.close,o||3e3)),u.push(c),p+=1,c}}(),RED.search=function(){var n,l,e=!1,o=null,d=-1,t=!1,c={},u=[],p=[];function i(t){var e="";if(t._def&&t._def.label){e=t._def.label;try{(e="function"==typeof e?e.call(t):e)&&(e=(""+e).toLowerCase(),c[e]=c[e]||{},c[e][t.id]={node:t,label:e})}catch(e){console.log("Definition error: "+t.type+".label",e)}}e=e||t.label||t.name||t.id||"";for(var n=["id","type","name","label","info"],o=0;o<n.length;o++)if(t.hasOwnProperty(n[o])){var i=t[n[o]];"string"!=typeof i&&"number"!=typeof i||(i=(""+i).toLowerCase(),c[i]=c[i]||{},c[i][t.id]={node:t,label:e})}}function a(){var e=l.find("li.selected");if(1===e.length){var t=l.parent(),n=t.height(),o=(t.scrollTop(),e.position().top),i=e.height();n<o+i?t.animate({scrollTop:"-="+(n-(o+i)-10)},50):o<0&&t.animate({scrollTop:"+="+(o-10)},50)}}function r(){o=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(o);(n=$('<input type="text" placeholder="search your flows">').appendTo(e).searchBox({delay:200,change:function(){!function(e){if(l.editableList("empty"),d=-1,p=[],0<e.length){var t,n;e=e.toLowerCase();var o=[],i={};for(t=0;t<u.length;t++){var a=u[t],r=u[t].indexOf(e);if(-1<r)for(n=0;n<c[a].length;n++){var s=c[a][n];i[s.node.id]=i[s.node.id]=s,i[s.node.id].index=Math.min(i[s.node.id].index||1/0,r)}}for((o=Object.keys(i)).sort(function(e,t){return i[e].index-i[t].index}),t=0;t<o.length;t++)p.push(i[o[t]]);if(0<p.length)for(t=0;t<Math.min(p.length,25);t++)l.editableList("addItem",p[t]);else l.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var t;0<p.length&&(40===e.keyCode?(t=l.children(),d<t.length-1&&(-1<d&&$(t[d]).removeClass("selected"),d++),$(t[d]).addClass("selected"),a(),e.preventDefault()):38===e.keyCode?(t=l.children(),0<d&&(d<t.length&&$(t[d]).removeClass("selected"),d--),$(t[d]).addClass("selected"),a(),e.preventDefault()):13===e.keyCode&&0<p.length&&f(p[Math.max(0,d)].node))});var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(o);l=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e);else{var i=o._def,a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),s=i.color,l="arrow-in.png";if("tab"===o.type)s="#C0DEED",l="subflow.png";else if("config"===i.category)l="cog.png";else if("unknown"===o.type)l="alert.png";else try{l="function"==typeof i.icon?i.icon.call({}):i.icon}catch(e){console.log("Definition error: "+nt+".icon",e)}r.css("backgroundColor",s);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(r);$("<div/>",{class:"palette_icon",style:"background-image: url(icons/"+l+")"}).appendTo(d);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a);if(o.z){var u=RED.nodes.workspace(o.z);u=u?"flow:"+u.label:"subflow:"+(u=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).html(u).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).html(n.label||o.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).html(o.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).html(o.id).appendTo(c),a.click(function(e){e.preventDefault(),f(o)})}},scrollOnAdd:!1})}function f(e){h(),RED.view.reveal(e.id)}function s(){t||(RED.keyboard.add("*",27,function(){h(),d3.event.preventDefault()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),c={},RED.nodes.eachWorkspace(i),RED.nodes.eachSubflow(i),RED.nodes.eachConfig(i),RED.nodes.eachNode(i),(u=Object.keys(c)).sort(),u.forEach(function(t){c[t]=Object.keys(c[t]).map(function(e){return c[t][e]})}),null===o&&r(),o.slideDown(),RED.events.emit("search:open"),t=!0),n.focus()}function h(){t&&(RED.keyboard.remove(27),t=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==o&&o.slideUp(200,function(){n.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.keyboard.add("*",190,{ctrl:!0},function(){e||s(),d3.event.preventDefault()}),RED.events.on("editor:open",function(){e=!0}),RED.events.on("editor:close",function(){e=!1}),RED.events.on("palette-editor:open",function(){e=!0}),RED.events.on("palette-editor:close",function(){e=!1}),$("#header-shade").on("mousedown",h),$("#editor-shade").on("mousedown",h),$("#palette-shade").on("mousedown",h),$("#sidebar-shade").on("mousedown",h)},show:s,hide:h}}(),RED.subflow=function(){function l(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var i;(i=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&i.y==n.y&&(n.x+=55,o=0)}return n}function r(){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.in.length){var n=t.in[0],o=[];return RED.nodes.eachLink(function(e){"subflow"==e.source.type&&e.source.z==t.id&&e.source.i==n.i?o.push(e):e.target.type=="subflow:"+t.id&&o.push(e)}),o.forEach(function(e){RED.nodes.removeLink(e)}),t.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),t.changed=!0,{subflowInputs:[n],links:o}}}function s(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],r=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&r.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),r.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var s=o.i;s<t.out.length;s++)t.out[s].i--,t.out[s].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function d(t){var n=RED.nodes.subflow(RED.workspaces.active());c(n);var o=[];if(n)return RED.nodes.filterNodes({type:"subflow:"+n.id}).forEach(function(e){for(o.push({id:e.id,changed:e.changed}),t&&(e.changed=!0),e.inputs=n.in.length,e.outputs=n.out.length;e.outputs<e.ports.length;)e.ports.pop();e.resize=!0,e.dirty=!0,RED.editor.updateNodeProperties(e)}),RED.editor.validateNode(n),{instances:o}}function c(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").html(e.out.length))}function n(a){var e=$("#workspace-toolbar");e.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(e),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(e),e.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=a.changed,o=s();if(o){var i=d(!0);RED.history.push({t:"delete",links:o.links,subflowOutputs:o.subflowOutputs,changed:n,dirty:t,subflow:{instances:i.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(e){e.preventDefault(),function(e){var t=RED.nodes.subflow(RED.workspaces.active()),n=l(t,!1),o={type:"subflow",direction:"out",z:t.id,i:t.out.length,x:n.x,y:n.y,id:RED.nodes.id()},i=t.out.length;t.out.push(o),t.dirty=!0;var a=RED.nodes.dirty(),r=t.changed;t.changed=!0;var s={t:"edit",node:t,dirty:a,changed:r,subflow:{outputCount:i,instances:d(!0).instances}};RED.history.push(s),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(t.out.length)}()}),$("#workspace-subflow-input-add").click(function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active());if(1!==e.in.length){var t=l(e,!0),n={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:t.x,y:t.y,id:RED.nodes.id()},o=e.in.length;e.in.push(n),e.dirty=!0;var i=RED.nodes.dirty(),a=e.changed;e.changed=!0;var r={t:"edit",node:e,dirty:i,changed:a,subflow:{inputCount:o,instances:d(!0).instances}};RED.history.push(r),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=a.changed;a.changed=!0;var o=r();if(o){var i=d(!0);RED.history.push({t:"delete",links:o.links,changed:n,subflowInputs:o.subflowInputs,dirty:t,subflow:{instances:i.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=[],n=[],o=RED.nodes.dirty(),i=RED.nodes.subflow(RED.workspaces.active());RED.nodes.eachNode(function(e){e.type=="subflow:"+i.id&&t.push(e),e.z==i.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==i.id&&t.push(e)});for(var a=[],r=0;r<t.length;r++){var s=RED.nodes.remove(t[r].id);n=n.concat(s.links),a=a.concat(s.nodes)}t=t.concat(a),RED.nodes.removeSubflow(i),RED.history.push({t:"delete",nodes:t,links:n,subflow:{subflow:i},dirty:o}),RED.workspaces.remove(i),RED.nodes.dirty(!0),RED.view.redraw()}),c(a),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?n(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)})},createSubflow:function(){var n=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(n=Math.max(n,t[1]))});var e="Subflow "+(n+1),t=RED.nodes.id(),o={type:"subflow",id:t,name:e,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(t),RED.nodes.dirty(!0)},convertToSubflow:function(){var e=RED.view.selection();if(e.nodes){var t,i,a={},o=[],n=[],r=[],s=[],l={},d=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)i=e.nodes[t],a[i.id]={n:i,outputs:{}},d=[Math.min(d[0],i.x),Math.min(d[1],i.y),Math.max(d[2],i.x),Math.max(d[3],i.y)];var c=[(d[2]+d[0])/2,(d[3]+d[1])/2];RED.nodes.eachLink(function(e){a[e.source.id]&&a[e.target.id],a[e.source.id]&&!a[e.target.id]&&(s.push(e),n.push(e)),!a[e.source.id]&&a[e.target.id]&&(r.push(e),l[e.target.id]=e.target,n.push(e))});var u={};if((s=s.filter(function(e){return u[e.source.id+":"+e.sourcePort]?(u[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),u[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),1<Object.keys(l).length)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var p=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(p=Math.max(p,t[1]))});var f="Subflow "+(p+1),h=RED.nodes.id(),g={type:"subflow",id:h,name:f,info:"",in:Object.keys(l).map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:l[e].x-l[e].w/2-80,y:l[e].y,z:h,i:n,id:RED.nodes.id(),wires:[{id:l[e].id}]}}),out:s.map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:e.source.x+e.source.w/2+80,y:e.source.y,z:h,i:n,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(g);var v={id:RED.nodes.id(),type:"subflow:"+g.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:g.in.length,outputs:g.out.length,h:Math.max(30,15*(g.out.length||0)),changed:!0};for(v._def=RED.nodes.getType(v.type),RED.editor.validateNode(v),RED.nodes.add(v),r.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:v};o.push(t),RED.nodes.addLink(t)}),s.forEach(function(e,n){e.targets.forEach(function(e){var t={source:v,sourcePort:n,target:e};o.push(t),RED.nodes.addLink(t)})}),g.in.forEach(function(n){n.wires.forEach(function(e){var t={source:n,sourcePort:0,target:RED.nodes.node(e.id)};o.push(t),RED.nodes.addLink(t)})}),g.out.forEach(function(n,e){n.wires.forEach(function(e){var t={source:RED.nodes.node(e.id),sourcePort:e.port,target:n};o.push(t),RED.nodes.addLink(t)})}),t=0;t<n.length;t++)RED.nodes.removeLink(n[t]);for(t=0;t<e.nodes.length;t++)i=e.nodes[t],/^link /.test(i.type)&&(i.links=i.links.filter(function(e){var t=a.hasOwnProperty(e);if(!t){var n=RED.nodes.node(e);if(n&&n.links){var o=n.links.indexOf(i.id);-1<o&&n.links.splice(o,1)}}return t})),i.z=g.id;RED.history.push({t:"createSubflow",nodes:[v.id],links:o,subflow:{subflow:g},activeWorkspace:RED.workspaces.active(),removedLinks:n,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(g),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")},refresh:d,removeInput:r,removeOutput:s}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var f=null,h=!1,g=!1,v=null;return{show:function(e,a,t){h=!0;try{$("body").width(),$("body").height();for(var o=(f=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){p(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:a[1]-80+"px",left:a[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),r=[],n=function(e,t,n){n.el=o.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,r.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){p(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},i=t.length,s=Math.max(Math.PI/(i-1),Math.PI/4),l=Math.PI,d=0;d<i;d++){var c=Math.floor(80*Math.cos(l)),u=Math.floor(80*Math.sin(l));t[d].name&&n(c,u,t[d]),l+=s}var p=function(){h=!1,v=null,f.remove(),f=null};e.on("touchend.radial",function(){if(e.on("touchend.radial",null),e.on("touchmenu.radial",null),v){try{v.onselect()}catch(e){RED._debug(e)}p()}else g&&p()}),e.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],n=0;n<r.length;n++){var o=r[n];o.disabled||(t[0]>o.x-30&&t[0]<o.x+30&&t[1]>o.y-30&&t[1]<o.y+30?o!==v&&(o.el.style("background","#999"),v=o):o===v?(o.el.style("background","#fff"),v=null):o.el.style("background","#fff"))}if(!v){var i=Math.abs(t[0]*t[0]+t[1]*t[1]);g=6400<i}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return h}}}();